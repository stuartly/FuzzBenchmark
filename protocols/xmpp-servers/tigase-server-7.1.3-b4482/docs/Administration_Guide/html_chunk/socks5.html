<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Socks 5 Component</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="loadComponent.html" title="Chapter&nbsp;8.&nbsp;Configuring the Tigase Server to Load a Component"><link rel="prev" href="_configuration_12.html" title="Configuration"><link rel="next" href="tigase41virtualHosts.html" title="Virtual Hosts in Tigase Server"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Socks 5 Component</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_configuration_12.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;8.&nbsp;Configuring the Tigase Server to Load a Component</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="tigase41virtualHosts.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="socks5"></a>Socks 5 Component</h2></div></div></div><p>Tigase SOCKS5 component allows for file transfers to be made over a SOCKS5 proxy in accordance with <a class="link" href="http://xmpp.org/extensions/xep-0065.html" target="_top">XEP-0065 SOCKS5 Bytestreams</a>.  This allows for some useful features such as:
- transfer limits per user, domain, or global
- recording transfers between users
- quotas and credits system implementation</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_installation_3"></a>Installation</h3></div></div></div><p>Tigase SOCKS5 component comes built into the dist-max archives for Tigase XMPP server, and requires the component to be listed in init.properties file:</p><pre class="programlisting">--comp-name-3=proxy
--comp-class-3=tigase.socks5.Socks5ProxyComponent</pre><p>You will also need to decide if you wish to use database-based features or not.  If you wish to simply run the socks5 proxy without features such as quotas, limits add the following line:</p><pre class="programlisting">proxy/verifier-class=tigase.socks5.verifiers.DummyVerifier</pre><p>This will enable the SOCKS5 Proxy without any advanced features.  If you wish to use those features, see the configuration section below.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_database_preparation"></a>Database Preparation</h3></div></div></div><p>In order to use the more advanced features of the SOCKS5 Proxy Component, your database needs to be prepared with the proper schema prior to running the server.</p><p>You may either edit an existing database, or create a new database for specific use with the Proxy.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_edit_existing_database"></a>Edit Existing Database</h4></div></div></div><p>You can add the proper schema to your existing database using the DBSchemaLoader utility included with Tigase.  The database folder contains the schema file for your type of database.</p><p>First, backup your database before performing any actions and shut down Tigase XMPP Server.</p><p>Then from the Tigase installation directory run the following command:</p><pre class="programlisting">java -cp "jars/*" tigase.util.DBSchemaLoader -dbType {derby,mysql,postgresql,sqlserver} - dbHostname {db address} -dbName {dbname} -rootUser root -rootPass root -file database/{dbtype}-socks5-schema.sql</pre><p>You should see the following dialogue</p><pre class="screen">LogLevel: CONFIG
tigase.util.DBSchemaLoader     	 &lt;init&gt;          	 CONFIG     Properties: [{dbHostname=localhost, logLevel=CONFIG, dbType=derby, file=database/derby-socks5-schema.sql, rootUser=root, dbPass=tigase_pass, dbName=tigasedb, schemaVersion=7-1, rootPass=root, dbUser=tigase_user}]
tigase.util.DBSchemaLoader     	 validateDBConnection 	 INFO       Validating DBConnection, URI: jdbc:derby:tigasedb;create=true
tigase.util.DBSchemaLoader     	 validateDBConnection 	 CONFIG     DriverManager (available drivers): [[jTDS 1.3.1, org.apache.derby.jdbc.AutoloadedDriver@34a245ab, com.mysql.jdbc.Driver@3941a79c, org.postgresql.Driver@6e2c634b]]
tigase.util.DBSchemaLoader     	 validateDBConnection 	 INFO       Connection OK
tigase.util.DBSchemaLoader     	 validateDBExists 	 INFO       Validating whether DB Exists, URI: jdbc:derby:tigasedb;create=true
tigase.util.DBSchemaLoader     	 validateDBExists 	 INFO       Exists OK
tigase.util.DBSchemaLoader     	 loadSchemaFile  	 INFO       Loading schema from file: database/derby-socks5-schema.sql, URI: jdbc:derby:tigasedb;create=true
tigase.util.DBSchemaLoader     	 loadSchemaFile  	 INFO        completed OK
tigase.util.DBSchemaLoader     	 shutdownDerby   	 INFO       Validating DBConnection, URI: jdbc:derby:tigasedb;create=true
tigase.util.DBSchemaLoader     	 shutdownDerby   	 WARNING    Database 'tigasedb' shutdown.
tigase.util.DBSchemaLoader     	 printInfo       	 INFO

Database init.properties configuration:

--user-db=derby
--user-db-uri=jdbc:derby:tigasedb;create=true</pre><p>One this process is complete, you may begin using SOCKS5 proxy component.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_create_new_database"></a>Create New Database</h4></div></div></div><p>If you want to create a new database for the proxy component and use it as a separate socks5 database, create the database using the appropriate schema file in the database folder.
Once this is created, add the following line to your init.properties folder.</p><pre class="programlisting">proxy/repo-url=driver:address</pre><p>For example, a mysql database will have this type of URL: jdbc:mysql://localhost/SOCKS?user=root&amp;password=root to replace {database URL}.  For more options, check the database section of <a class="link" href="databasePreperation.html" title="Database Preparation">this documentation</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuration_13"></a>Configuration</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__emphasis_role_strong_verifier_class_emphasis"></a><span class="strong"><strong>verifier-class</strong></span></h4></div></div></div><pre class="programlisting">proxy/verifier-class=</pre><p>Specifies the class used to verify transfer limits.  The following options are available:</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_limitsverifier"></a>LimitsVerifier</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Class Name: tigase.socks5.verifiers.LimitsVerifier</li></ul></div><p>Uses the database to store limits and record the amount of data transferred VIA the proxy. It accepts one parameter, transfer-update-quantization which is used to create a value to check if the value of transferred bytes should be updated in the database or not.  By default, this value is 1MB.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Low values can slow down file transfers, while high values can allow for users to exceed quotas.</p></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_dummyverifier"></a>DummyVerifier</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Class Name: tigase.socks5.verifiers.DummyVerifier</li></ul></div><p>This accepts file transfers VIA SOCKS5 proxy from any user and does not check limitations against the database.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__emphasis_role_strong_socks5_repo_cls_emphasis"></a><span class="strong"><strong>socks5-repo-cls</strong></span></h4></div></div></div><pre class="programlisting">proxy/socks5-repo-cls=</pre><p>Specifies implementation of repository used to store usage statistics.  Two options are available for this setting:
- tigase.socks5.verirepository.JDBCSocks5Repository - Uses the database implementation.
- tigase.socks5.repository.DummySocks5Repository - ignores data storage, and is the default implementation.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__emphasis_role_strong_repo_url_emphasis"></a><span class="strong"><strong>repo-url</strong></span></h4></div></div></div><pre class="programlisting">proxy/repo-url=</pre><p>The database connection URL for the socks5 repository.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__emphasis_role_strong_verifier_params_emphasis"></a><span class="strong"><strong>verifier-params</strong></span></h4></div></div></div><pre class="programlisting">proxy/repo-params=</pre><p>Comma separated parameters for LimitsVerifier which will override the defaults.  All of these limits are on a per calendar month basis.
For example, a user is limited to 10MB for all transfers.  If he transfers 8MB between the 1st and the 22nd, he only has 2MB left in his limit.  On the 1st of the following month, his limit is reset to 10MB.</p><p>Available parameters:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">global-limit - Transfer limit for all domains in MB per month.</li><li class="listitem">instance-limit - Transfer limit for server instance in MB per month.</li><li class="listitem">default-domain-limit - The Default transfer limit per domain in MB per month.</li><li class="listitem">default-user-limit - The default transfer limit per user in MB per month.</li><li class="listitem">default-file-limit - The default transfer limit per file in MB per month.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__emphasis_role_strong_remote_addresses_emphasis"></a><span class="strong"><strong>remote-addresses</strong></span></h4></div></div></div><pre class="programlisting">proxy/remote-addresses=</pre><p>A comma separated list of IP addresses that will be accessible VIA the Socks5 Proxy.  This can be useful if you want to specify a specific router address to allow external traffic to transfer files using the proxy to users on an internal network.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_port_settings"></a>Port settings</h4></div></div></div><p>If socks5 is being used as a proxy, you may configure a specific ports for the proxy using the following line in init.properties:</p><pre class="programlisting">proxy/connections/ports[i]=1080</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_database_usage_for_specific_settings"></a>Database usage for specific settings</h3></div></div></div><p>The above configuration allows for global settings, however you may also define specifics for users and the scopes of those limitations by editing the database information directly.</p><p>The user_id field denotes the scope of the limitation.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Using a domain_name defines limits for all users whose JIDs are within that domain.</li><li class="listitem">Using a JID of a user defines limit for this exact user.</li></ol></div><p>If the value set is larger than 0, that is the specific limit.
If value is equal to 0 the limit is not overridden and the global limit is used.
If value equals -1 proxy will forbid any transfer for this user.
It there is no value for user in this table, a new row will be created during first transfer and limits for domain or global limits will be used.</p><p>Socks5 database is setup in this manner:</p><div class="informaltable"><table border="1" width="100%"><colgroup><col class="col_1"><col class="col_2"><col class="col_3"><col class="col_4"><col class="col_5"><col class="col_6"><col class="col_7"><col class="col_8"></colgroup><thead><tr><th align="left" valign="top">uid</th><th align="left" valign="top">user_id</th><th align="left" valign="top">sha1_user_id</th><th align="left" valign="top">domain</th><th align="left" valign="top">sha1_domain</th><th align="left" valign="top">filesize_limit</th><th align="left" valign="top">transfer_limit_per_user</th><th align="left" valign="top">transfer_limit_per_domain</th></tr></thead><tbody><tr><td align="left" valign="top"><p>1</p></td><td align="left" valign="top"><p><a class="link" href="mailto:user@domain.com" target="_top">user@domain.com</a></p></td><td align="left" valign="top"><p>c35f2956d804e01ef2dec392ef3adae36289123f</p></td><td align="left" valign="top"><p>domain.com</p></td><td align="left" valign="top"><p>e1000db219f3268b0f02735342fe8005fd5a257a</p></td><td align="left" valign="top"><p>0</p></td><td align="left" valign="top"><p>3000</p></td><td align="left" valign="top"><p>0</p></td></tr><tr><td align="left" valign="top"><p>2</p></td><td align="left" valign="top"><p>domain.com</p></td><td align="left" valign="top"><p>e1000db219f3268b0f02735342fe8005fd5a257a</p></td><td align="left" valign="top"><p>domain.com</p></td><td align="left" valign="top"><p>e1000db219f3268b0f02735342fe8005fd5a257a</p></td><td align="left" valign="top"><p>500</p></td><td align="left" valign="top"><p>0</p></td><td align="left" valign="top"><p>0</p></td></tr></tbody></table></div><p>This example table shows that <a class="link" href="mailto:user@domain.com" target="_top">user@domain.com</a> is limited to 3000MB per transfer whereas all users of domain.com are limited to a max file size of 500MB.
This table will populate as users transfer files using the SOCKS5 proxy, once it begins population, you may edit it as necessary.
A second database is setup tig_socks5_connections that records the connections and transmissions being made, however it does not need to be edited.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_example_init_properties_block"></a>Example init.properties block</h3></div></div></div><p>Combined, your init.properties should look like the below excerpt to run socks5 transfers using a separate database.</p><pre class="programlisting">proxy/repo-url=jdbc:mysql://localhost/SOCKS?user=root&amp;password=root
proxy/verifier-class=tigase.socks5.verifiers.LimitsVerifier
proxy/socks5-repo-cls=tigase.socks5.verirepository.JDBCSocks5Repository</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_configuration_12.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="loadComponent.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="tigase41virtualHosts.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Configuration&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Virtual Hosts in Tigase Server</td></tr></table></div></body></html>