<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Tigase Load Balancing</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="loadComponent.html" title="Chapter&nbsp;8.&nbsp;Configuring the Tigase Server to Load a Component"><link rel="prev" href="tigaseMUC.html" title="Tigase MUC Component"><link rel="next" href="externalComponentConfiguration.html" title="External Component Configuration"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Tigase Load Balancing</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="tigaseMUC.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;8.&nbsp;Configuring the Tigase Server to Load a Component</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="externalComponentConfiguration.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="loadBalancing"></a>Tigase Load Balancing</h2></div></div></div><p>Starting with version 5.2.0 Tigase introduces a load balancing functionality allowing users to be redirected to the most suitable cluster node. Functionality relies on a see-other-host XMPP stream error message. The basic principle behind the mechanism is that user will get redirect if the host returned by the implementation differ from the host to which user currently tries to connect. It is required that the user JID to be known for the redirection to work correctly.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_available_implementations"></a>Available Implementations</h3></div></div></div><p>Tigase implementation is, as usual, extensible and allows for different, pluggable redirection strategies that implement the <code class="literal">SeeOtherHostIfc</code> interface.</p><p>Currently there are three strategies available:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">SeeOtherHost</code> - most basic implementation returning either single host configured in init.properties file or name of the current host;</li><li class="listitem"><code class="literal">SeeOtherHostHashed</code> (default) - default implementation for cluster environment of SeeOtherHostIfc returning redirect host based on the hash value of the user&#8217;s JID; list of the available nodes from which a selection would be made is by default composed and reflects all connected nodes, alternatively hosts list can be configured in the init.properties;</li><li class="listitem"><code class="literal">SeeOtherHostDB</code> - extended implementation of SeeOtherHost using redirect information from database in the form of pairs user_id and node_id to which given user should be redirected.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuration_options_2"></a>Configuration Options</h3></div></div></div><p>The most basic configuration is related to the choice of actual redirection implementation:</p><pre class="programlisting">--cm-see-other-host=</pre><p>Possible values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">tigase.server.xmppclient.SeeOtherHost</code></li><li class="listitem"><code class="literal">tigase.server.xmppclient.SeeOtherHostHashed</code></li><li class="listitem"><code class="literal">tigase.server.xmppclient.SeeOtherHostDB</code></li><li class="listitem"><code class="literal">tigase.server.xmppclient.SeeOtherHostDualIP</code></li><li class="listitem"><code class="literal">none</code> - disables redirection</li></ul></div><p>All the remaining options are configured on a per-connection-manager basis, thus all options need to be prefixed with the corresponding connection manager ID, i.e. c2s, bosh or ws; we will use c2s in the examples:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">c2s/cm-see-other-host/default-host=host1;host2;host3</code> - a semicolon separated list of hosts to be used for redirection;</li><li class="listitem"><p class="simpara"><code class="literal">c2s/cm-see-other-host/active=OPEN;LOGIN</code> - a semicolon separated list of phases in which redirection should be active, currently possible values are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: circle; "><li class="listitem"><code class="literal">OPEN</code> which enables redirection during opening of the XMPP stream;</li><li class="listitem"><code class="literal">LOGIN</code> which enables redirection upon authenticating user session;</li></ul></div></li></ul></div><p>By default redirection is currently enabled only in the <code class="literal">OPEN</code> phase.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_seeotherhostdb"></a>SeeOtherHostDB</h4></div></div></div><p>For <code class="literal">SeeOtherHostDB</code> implementation there are additional options:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">c2s/cm-see-other-host/db-url</code> - a JDBC connection URI which should be used to query redirect information; if not configured --user-db-uri will be used;</li><li class="listitem"><code class="literal">c2s/cm-see-other-host/get-host-query</code> - a SQL query which should return redirection hostname;</li><li class="listitem"><code class="literal">c2s/cm-see-other-host/get-all-data-query</code> - a SQL helper query which should return all redirection data from database;</li><li class="listitem"><code class="literal">c2s/cm-see-other-host/get-all-query-timeout</code> - allows to set timeout for executed queries.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_seeotherhostdualip"></a>SeeOtherHostDualIP</h4></div></div></div><p>This mechanisms matches internal Tigase cluster nodes with against the lookup table to provide matching and relevant redirection hostname/IP. By default internal Tigase <code class="literal">cluster_nodes</code> table will be used (and appropriate repository implementation will be used).</p><p>To enable this redirection mechanism following configuration / class should be used:</p><pre class="programlisting">--cm-see-other-host=tigase.server.xmppclient.SeeOtherHostDualIP</pre><p>It&#8217;s possible to configure it on per-connection-manager basis</p><pre class="programlisting">&lt;connector&gt;/cm-see-other-host[S]=tigase.server.xmppclient.SeeOtherHostDualIP</pre><p>It offers following configuration options:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">data-source</code> - configuration of the source of redirection information - by default internal Tigase <code class="literal">cluster_nodes</code> table will be used (and appropriate repository implementation will be used); alternatively it&#8217;s possible to use <code class="literal">eventbus</code> source;</li><li class="listitem"><code class="literal">db-url</code> - a JDBC connection URI which should be used to query redirect information; if not configured <code class="literal">--user-db-uri</code> will be used;</li><li class="listitem"><code class="literal">get-all-data-query</code> - a SQL helper query which should return all redirection data from database;</li><li class="listitem"><code class="literal">get-all-query-timeout</code> - allows to set timeout for executed queries;</li><li class="listitem"><code class="literal">fallback-redirection-host</code> - if there is no redirection information present (i.e. secondary hostname is not configured for the particular node) redirection won&#8217;t be generated; with this it&#8217;s possible to configure fallback redirection address.</li></ul></div><p>All options can be configured either globally (without providing type parameter)</p><pre class="programlisting">--cm-see-other-host/db-url=jdbc:&lt;database&gt;://&lt;uri&gt;
--cm-see-other-host/data-source=&lt;class implementing tigase.server.xmppclient.SeeOtherHostDualIP.DualIPRepository&gt;
--cm-see-other-host/get-all-data-query=select * from cluster_nodes
--cm-see-other-host/get-all-query-timeout=10
--cm-see-other-host/fallback-redirection-host=&lt;hostname&gt;</pre><p>or on per-component basis</p><pre class="programlisting">&lt;connector&gt;/cm-see-other-host/db-url[S]=jdbc:&lt;database&gt;://&lt;uri&gt;
&lt;connector&gt;/cm-see-other-host/data-source[S]=&lt;class implementing tigase.server.xmppclient.SeeOtherHostDualIP.DualIPRepository&gt;
&lt;connector&gt;/cm-see-other-host/get-all-data-query[S]=select * from cluster_nodes
&lt;connector&gt;/cm-see-other-host/get-all-query-timeout[I]=10
&lt;connector&gt;/cm-see-other-host/fallback-redirection-host[S]=&lt;hostname&gt;</pre><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_eventbus_as_a_source_of_information"></a>EventBus as a source of information</h5></div></div></div><p>It&#8217;s possible to utilize EventBus and internal Tigase events as a source of redirection data. In order to do that <code class="literal">eventbus</code> should be used as a value of <code class="literal">data-source</code> configuration option. In addition, EventBus events needs to be enabled in ClusterConnectionManager. Example configuration:</p><pre class="programlisting">cl-comp/eventbus-repository-notifications[B]=true
--cm-see-other-host/data-source=eventbus</pre><p>or on per-component basis:</p><pre class="programlisting">cl-comp/eventbus-repository-notifications[B]=true
&lt;connector&gt;/cm-see-other-host/data-source[S]=eventbus</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_auxiliary_setup_options"></a>Auxiliary setup options</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_enforcing_redirection"></a>Enforcing redirection</h4></div></div></div><p>It&#8217;s possible to enforce redirection of connections on the particular port of connection manager with <code class="literal">force-redirect-to</code> set to Integer with the following general setting option:</p><pre class="programlisting">&lt;connection_manager&gt;/connections/&lt;listening_port&gt;/force-redirect-to[I]=&lt;destination_port&gt;</pre><p>for example, enable additional port <code class="literal">5322</code> for <code class="literal">c2s</code> connection manager and enforce all connections to be redirected to port <code class="literal">5222</code> (it will utilize hostname retrieved from <code class="literal">SeeOtherHost</code> implementation and will be only used when such value is returned):</p><pre class="programlisting">c2s/connections/ports[i]=5222,5322
c2s/connections/5322/type[S]=accept
c2s/connections/5322/socket[S]=plain
c2s/connections/5322/force-redirect-to[I]=5222</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_hostnames"></a>Configuring hostnames</h4></div></div></div><p>To fully utilize <code class="literal">SeeOtherHostDualIP</code> setup in automated fashion it&#8217;s now possible to provide both primary (<span class="emphasis"><em>internal</em></span>) and secondary (<span class="emphasis"><em>external</em></span>) hostname/IP (they need to be correct, <code class="literal">InetAddress.getByName( property );</code> will be used to verify correctnes). It can be done via JVM properties <code class="literal">tigase-primary-address</code> and <code class="literal">tigase-secondary-address</code>. You can also utilize different implementation of DNS resolver by providing class implementing <code class="literal">tigase.util.DNSResolverIfc</code> interface as value to <code class="literal">resolver-class</code> property.
Those properties can be set via <code class="literal">etc/tigase.conf</code> (uncommenting following lines, or manually exposing in environment):</p><pre class="programlisting">DNS_RESOLVER=" -Dresolver-class=tigase.util.DNSResolverDefault "

INTERNAL_IP=" -Dtigase-primary-address=hostname.local "
EXTERNAL_IP=" -Dtigase-secondary-address=hostname "</pre><p>or in the <code class="literal">etc/init.properties</code> (they will be converted to JVM properties):</p><pre class="programlisting">--tigase-resolver-class=tigase.util.DNSResolverDefault

--tigase-primary-address=hostname.local
--tigase-secondary-address=hostname</pre></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tigaseMUC.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="loadComponent.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="externalComponentConfiguration.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Tigase MUC Component&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;External Component Configuration</td></tr></table></div></body></html>