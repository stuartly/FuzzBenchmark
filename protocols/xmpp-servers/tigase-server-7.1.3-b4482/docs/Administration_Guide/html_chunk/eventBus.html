<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Eventbus</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="loadComponent.html" title="Chapter&nbsp;8.&nbsp;Configuring the Tigase Server to Load a Component"><link rel="prev" href="serverMonitoring.html" title="Server Monitoring"><link rel="next" href="v5xs2sps.html" title="Server to Server Protocol Settings"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Eventbus</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="serverMonitoring.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;8.&nbsp;Configuring the Tigase Server to Load a Component</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="v5xs2sps.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="eventBus"></a>Eventbus</h2></div></div></div><p>New for Tigase version 7.1.0, is an <span class="strong"><strong>eventbus</strong></span> component to help with monitoring has been implemented. This allows you to set thresholds for certain predefined tasks and you or other JIDs can be sent a message when those thresholds are passed. You can even configure a mailer extension to have an E-mail sent to system administrators to let them know an event has occured!
Lets begin with setup and requirements.</p><p>Eventbus is based on a limited <a class="link" href="http://www.xmpp.org/extensions/xep-0060.html" target="_top">PubSub</a> specification. Events are delivered to subscribers as a normal PubSub notification.</p><p>Each component or client may subscribe for specific types of events. Only components on cluster nodes are allowed to publish events.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_setup"></a>Setup</h3></div></div></div><p>Eventbus is enabled by default on v7.1.0 b4001 and later, no setup needed!</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_how_it_works_2"></a>How it Works</h3></div></div></div><p>Events in Eventbus are identified by two elements: name of event and its namespace:</p><pre class="programlisting">&lt;EventName xmlns="tigase:demo"&gt;
  &lt;sample_value&gt;1&lt;/sample_value&gt;
&lt;/EventName&gt;</pre><p>Where event name is <code class="literal">EventName</code> and namespace is <code class="literal">tigase:demo</code>.</p><p>Listeners may subscribe for a specific event or for all events with specific a namespace. Because in pubsub, only one node name exists, so we have to add a way to convert the event name and namespace to a node name:</p><pre class="screen">nodename = eventname + "|" + namespace</pre><p>So for example, to subscribe to <code class="literal">&lt;EventName xmlns="tigase:demo"&gt;</code>, node must be: <code class="literal">EventName|tigase:demo</code>. If you wish to subscribe to all events with a specific namespace, use an asterisk (<code class="literal">*</code>) instead of the event name: *|tigase:demo.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>If client is subscribed to /<span class="strong"><strong>|tigase:demo node, then events will not be sent from node /</strong></span>|tigase:demo, but from the <span class="strong"><strong>real</strong></span> node (in this case: <code class="literal">EventName|tigase:demo</code>).</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="availableTasks"></a>Available Tasks</h3></div></div></div><p>Eventbus monitoring has several pre-defined tasks that can be monitored and set to trigger. What follows is the list of tasks with the options attributed to each task.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara"><span class="strong"><strong>disk-task</strong></span> - Used to check disk usage.
Available Options</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">enabled[B] - Enable or disable task, Boolean value.</li><li class="listitem">period[I] - Period of running check, Integer value.</li><li class="listitem">threshold - Percentage of used space on disk, Float value.</li></ol></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>cpu-temp-task</strong></span> - Used to check CPU temperature.
Available Options</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">enabled[B] - Enable or disable task, Boolean value.</li><li class="listitem">period[I] - Period of running check, Integer value.</li><li class="listitem">cpuTempThreshold[I] - Temperature threshold of CPU in &deg;C.</li></ol></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>load-checker-task</strong></span> - Used to check system load.
Available Options</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">enabled[B] - Enable or disable task, Boolean value.</li><li class="listitem">period[I] - Period of running check, Integer value.</li><li class="listitem">averageLoadThreshold[L] - Average percent load threshold, Long value.</li></ol></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>memory-checker-task</strong></span> - Used to check memory usage.
Available Options</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">enabled[B] - Enable or disable task, Boolean value.</li><li class="listitem">period[I] - Period of running check, Integer value.</li><li class="listitem">maxHeapMemUsagePercentThreshold[I] - Alarm when percent of used Heap memory is larger than, Integer value.</li><li class="listitem">maxNonHeapMemUsagePercentThreshold[I] - Alarm when percent of used Non Heap memory is larger than, Integer value.</li></ol></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>logger-task</strong></span> - Used to transmit log entries depending on level entered.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">enabled[B] - Enable or disable task, Boolean value.</li><li class="listitem">levelThreshold - Minimal log level that will be the threshold. Possible values are SEVERE, WARNING, INFO, CONFIG, FINE, FINER, FINEST, and ALL.</li></ol></div></li><li class="listitem"><p class="simpara"><span class="strong"><strong>connections-task</strong></span> - Used to check users disconnections.
<span class="strong"><strong>NOTE: The event will be generated only if both thresholds (amount and percentage) will be fulfilled.</strong></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">enabled[B] - Enable or disable task, Boolean value.</li><li class="listitem">period[I] - Period of running check in ms, Integer value.</li><li class="listitem">thresholdMinimal[I] - Minimal amount of disconnected users required to generate alarm.</li><li class="listitem">threshold[I] - Minimal percent of disconnected users required to generate alarm.</li></ol></div></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuration_11"></a>Configuration</h3></div></div></div><p>Configuration of the eventbus monitor can be done one of two ways; either by lines in init.properties file, or by sending XMPP stanzas to the server.  You may also send XMPP stanzas VIA HTTP REST.
XMPP stanza configurations will override ones in init.properties, but they will only last until the server restarts.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_init_properties"></a>init.properties</h4></div></div></div><p>Tasks can be configured in the init.properties file. See <a class="link" href="eventBus.html#availableTasks" title="Available Tasks">available tasks</a> for the tasks that can be setup.</p><p>To enable a specific monitor task, use the following line:</p><pre class="screen">monitor/$TASKNAME/enabled[B]=true</pre><p>Where monitor is the component name for tigase.monitor.MonitorComponent, and $TASKNAME is one of the <a class="link" href="eventBus.html#availableTasks" title="Available Tasks">available task names</a>.</p><p>This format will be the same for other settings for tasks.  For example:</p><pre class="screen">monitor/$TASKNAME/period[I]=1000</pre><p>which sets the check period to 1000 milliseconds.</p><p><span class="strong"><strong>NOTE</strong></span> Once triggers have been activated, they will become dormant.  Think of these as one-shot settings.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_subscription_limitations"></a>Subscription Limitations</h5></div></div></div><p>To define list of JIDs allowed to subscribe for events:</p><pre class="programlisting">eventbus/affiliations/allowedSubscribers=francisco@denmark.lit,bernardo@denmark.lit</pre><p>If this is left blank, all users can subscribe.</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuration_via_xmpp"></a>Configuration via XMPP</h4></div></div></div><p>We can also configure the eventbus monitor component using XMPP stanzas. This allows us to set and change configurations during server runtime. This is done using a series of iq stanzas send to the monitor component.</p><p>We can query each component for its current settings using the following stanza.</p><pre class="programlisting">&lt;iq type="set" to="monitor@$DOMAIN/disk-task" id="aad0a"&gt;
&lt;command xmlns="http://jabber.org/protocol/commands" node="x-config"/&gt;
&lt;/iq&gt;</pre><p>The server will return the component current settings which will make things easier if you wish to edit them. In this case, the server has returned the following to us</p><pre class="programlisting">&lt;iq from="monitor@$DOMAIN/disk-task" type="result" id="aad0a" to="alice@coffeebean.local/Psi+"&gt;
&lt;command xmlns="http://jabber.org/protocol/commands" status="executing" node="x-config" sessionid="0dad3436-a029-4082-b0e0-04d838c6c0da"&gt;
&lt;x xmlns="jabber:x:data" type=""&gt;
&lt;title&gt;Task Configuration&lt;/title&gt;
&lt;instructions/&gt;
&lt;field type="boolean" label="Enabled" var="x-task#enabled"&gt;
&lt;value&gt;0&lt;/value&gt;
&lt;/field&gt;
&lt;field type="text-single" label="Period [ms]" var="x-task#period"&gt;
&lt;value&gt;60000&lt;/value&gt;
&lt;/field&gt;
&lt;field type="text-single" label="Disk usage ratio threshold" var="threshold"&gt;
&lt;value&gt;0.8&lt;/value&gt;
&lt;/field&gt;
&lt;/x&gt;
&lt;/command&gt;
&lt;/iq&gt;</pre><p>This tells us that the disk-task setting is not active, has a period of 60000ms, and will trigger when disk usage is over 80%.</p><p>To send new settings to the monitor component, we can send a similar stanza back to the monitor component.</p><pre class="programlisting">&lt;iq type="set" to="monitor@$DOMAIN/disk-task" id="aad1a"&gt;
&lt;command xmlns="http://jabber.org/protocol/commands" node="x-config" sessionid="0dad3436-a029-4082-b0e0-04d838c6c0da"&gt;
&lt;x xmlns="jabber:x:data" type="submit"&gt;
&lt;field type="boolean" var="x-task#enabled"&gt;
&lt;value&gt;0&lt;/value&gt;
&lt;/field&gt;
&lt;field type="text-single" var="x-task#period"&gt;
&lt;value&gt;60000&lt;/value&gt;
&lt;/field&gt;
&lt;field type="text-single" var="threshold"&gt;
&lt;value&gt;0.8&lt;/value&gt;
&lt;/field&gt;
&lt;/x&gt;
&lt;/command&gt;
&lt;/iq&gt;</pre><p>To which a successful update will give you an XMPP success stanza to let you know everything is set correctly.</p><p>(Include what the response will be from this setting!)</p><p>Alternatively, you can update specific settings by editing a single field without adding anything else. For example, if we just wanted to turn the disk-task on we could send the following stanza:</p><pre class="programlisting">&lt;iq type="set" to="monitor@$HOSTNAME/disk-task" id="ab53a"&gt;
&lt;command xmlns="http://jabber.org/protocol/commands" node="x-config"&gt;
&lt;x xmlns="jabber:x:data" type="submit"&gt;
&lt;field type="boolean" var="x-task#enabled"&gt;
&lt;value&gt;1&lt;/value&gt;
&lt;/field&gt;
&lt;/x&gt;
&lt;/command&gt;
&lt;/iq&gt;</pre><p>To set any other values, do not forget that certain parts may need to be changed, specifically the
<span class="strong"><strong>&lt;field type="boolean" var=x-task#enabled"&gt;</strong></span>  fields.
- Your field type will be defined by the type of variable specified in the <a class="link" href="">Available Tasks</a> section.
- var=x task# will be followed by the property value taken directly from the <a class="link" href="">Available Tasks</a> section, minus the data type parameter.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_getting_the_message"></a>Getting the Message</h3></div></div></div><p>Without a place to send messages to, eventbus will just trigger and shut down. There are two different methods that eventbus can deliver alarm messages and relevant data; XMPP messages and using the mailer extension.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_xmpp_notification"></a>XMPP notification</h4></div></div></div><p>In order to retrieve notifications, a subscription to the eventbus@tigase.org user must be made.
Keep in mind that subscriptions are not persistent across server restarts, or triggers.
The eventbus schema is very similar to most XMPP subscription requests but with a few tweaks to differentiate it if you wanted to subscribe to a certain task or all of them. Each task is considered a node, and each node has the following pattern: eventName|eventXMLNS. Since each monitoring task has the tigase:monitor:event event XMLNS, we just need to pick the event name from the list of tasks.
So like the above example, our event node for the disk task will be disk-task|tigase:monitor:event.
Applied to an XMPP stanza, it will look something like this:</p><pre class="programlisting">&lt;iq type='set'
    to='eventbus@tigase.org'
    id='sub1'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;subscribe node='disk-taskEvent|tigase:monitor:event' jid='$USER_JID'/&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre><p>Don&#8217;t forget to replace $USER_JID with the bare JID of the user you want to receive those messages. You can even have them sent to a MUC or any component with a JID.
Available events are as follows:
- disk-taskEvent for disk-task
- LoggerMonitorEvent for logger-task
- HeapMemoryMonitorEvent for memory-checker-task
- LoadAverageMonitorEvent for load-checker-task
- CPUTempMonitorEvent for cpu-temp-task
- UsersDisconnected for connections-task</p><p>Alternatively, you can also subscribe to all events within the eventbus by using a wildcard * in place of the event XMLNS like this example:</p><pre class="programlisting">&lt;iq type='set'
    to='eventbus@tigase.org'
    id='sub1'&gt;
  &lt;pubsub xmlns='http://jabber.org/protocol/pubsub'&gt;
    &lt;subscribe node='*|tigase:monitor:event' jid='$USER_JID'/&gt;
  &lt;/pubsub&gt;
&lt;/iq&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_sample_notification_from_eventbus"></a>Sample notification from Eventbus</h4></div></div></div><pre class="programlisting">&lt;message from='eventbus.shakespeare.lit' to='francisco@denmark.lit' id='foo'&gt;
  &lt;event xmlns='http://jabber.org/protocol/pubsub#event'&gt;
    &lt;items node='EventName|tigase:demo'&gt;
      &lt;item&gt;
        &lt;EventName xmlns="tigase:demo" eventSource="samplecomponent.shakespeare.lit'" eventTimestamp="1444216850"&gt;
          &lt;sample_value&gt;1&lt;/sample_value&gt;
        &lt;/EventName&gt;
      &lt;/item&gt;
    &lt;/items&gt;
  &lt;/event&gt;
&lt;/message&gt;</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="monitorMailer"></a>Mailer Extension</h3></div></div></div><p>Tigase Server Monitor Mailer Extension (TSMME) can send messages from the monitor component to a specified E-mail address so system administrators who are not logged into the XMPP server.</p><p>For v7.1.0 versions and later, TSMME is already included in your distribution package and no extra installation is needed.</p><p>For versions older than 7.1.0 TSMME requires two files to operate:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">A compiled build of tigase mailer from <a class="link" href="https://projects.tigase.org/projects/tigase-server-ext-mailer/repository" target="_top">its repository</a>. Place the compiled .jar file into /jars directory.</li><li class="listitem">javax.mail.jar file which may be downloaded from <a class="link" href="http://java.net/projects/javamail/downloads/download/javax.mail.jar" target="_top">this link</a>. Also place this file in the /jars directory.</li></ul></div><pre class="programlisting">monitor/mailer-smtp-host=mail.tigase.org
monitor/mailer-smtp-port=587
monitor/mailer-smtp-username=sender
monitor/mailer-smtp-password=********
monitor/mailer-from-address=sender@tigase.org
monitor/mailer-to-addresses=receiver@tigase.org,admin@tigase.org</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">monitor/mailer-smtp-host - SMTP Server hostname.</li><li class="listitem">monitor/mailer-smtp-port - SMTP Server port.</li><li class="listitem">monitor/mailer-smtp-usernam - name of sender account.</li><li class="listitem">monitor/mailer-smtp-password - password of sender account.</li><li class="listitem">monitor/mailer-from-address - sender email address. It will be set in field from in email.</li><li class="listitem">monitor/mailer-to-addresses - comma separated notification receivers email addresses.</li></ul></div><p>It is recommended to create a specific e-mail address in your mail server for this purpose only, as the account settings are stored in plaintext without encryption.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="serverMonitoring.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="loadComponent.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="v5xs2sps.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Server Monitoring&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Server to Server Protocol Settings</td></tr></table></div></body></html>