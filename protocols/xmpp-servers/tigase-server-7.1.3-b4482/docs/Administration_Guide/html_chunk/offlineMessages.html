<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Offline Messages</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="_using_tigase_applies_to_all_tigase_server_versions.html" title="Chapter&nbsp;9.&nbsp;Using Tigase - Applies to All Tigase Server Versions"><link rel="prev" href="tigase3xconfiguration.html" title="Configuration Wizards"><link rel="next" href="licenseserver.html" title="Licensing"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Offline Messages</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="tigase3xconfiguration.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;9.&nbsp;Using Tigase - Applies to All Tigase Server Versions</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="licenseserver.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="offlineMessages"></a>Offline Messages</h2></div></div></div><p>Tigase like any XMPP server supports storing of messages for users who are offline so that they may receive messages sent to them while they were not logged in.</p><p>By default, Tigase MessageAmp processor is responsible for storing offline messages, and will automatically store offline messages.  This guide has multiple sections for setting limits globally, per user, and others.</p><p>Many of the features listed here require the use of the Advanced Message Processor Plugin which is turned on by default. To ensure AMP is turned on your system, view your init.properties file and be sure the following is there in your plugins line:</p><pre class="programlisting">--sm-plugins=+amp</pre><p>Messages will be delivered to intended recipients when they first login after roster exchange.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="offlineMessageLimits"></a>Offline Message Limits</h3></div></div></div><p>Support for limiting number of stored offline messages on a per-user basis has now been added to Tigase as of v7.1.0.  By default, Tigase comes with a limit of stored offline messages which is set for every user. This limit by default is 100 offline messages for barejid-barejid pair. This value can be changed by the store-limit property. To change to 200 messages on barejid-barejid paid, add the following entries to the init.properties file:</p><pre class="programlisting">sess-man/plugins-conf/amp/store-limit[L]=200
amp/store-limit[L]=200</pre><p>This setting applies to every user.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_user_limit"></a>User Limit</h4></div></div></div><p>Each user is able to configure the number of offline messages which should be stored for him. To enable this feature, the following lines need to be entered into the init.properties file:</p><pre class="programlisting">sess-man/plugins-conf/amp/user-store-limit-enable[B]=true
amp/user-store-limit-enable[B]=true</pre><p>Values of user-specific limits will be stored in UserRepository under subnode of offline-msgs and key store-limit. Data storage will be stored in tig_pairs key with the value and a proper record from tig_nodes points to this record.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_handling_of_offline_messages_exceeding_limits"></a>Handling of Offline Messages Exceeding Limits</h4></div></div></div><p>There are two possible ways to handle offline messages that exceed the limitations:
. error sending message with error type back to sender.
. drop drop of message without notifications to sender.</p><p>By default, Tigase sends a message back to the original sender with an error type of service-unavailable with a proper description of error according to <a class="link" href="http://www.xmpp.org/extensions/xep-0160.html" target="_top">XEP-0160</a>.
However, it is possible to change this behavior to better suit your needs. This is done by adding the following line to your init.properties file.</p><pre class="programlisting">sess-man/plugins-conf/amp/quota-exceeded=drop</pre><p>This will force Tigase to drop packets that exceed the offline message limit.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_setting_of_limits_by_user"></a>Setting of Limits by User</h4></div></div></div><p>Users wishing to set a custom limit of stored offline messages for barejid-barejid pairs needs to send the following XMPP stanza to the server:</p><pre class="programlisting">&lt;iq type="set" id="${random-id}"&gt;
  &lt;msgoffline xmlns="msgoffline" limit="${limit}"/&gt;
&lt;/iq&gt;</pre><p>Where:
. ${random-id} is a random ID of the stanza (can be any string).
. ${limit} is the integer value of the offline message limit. This can be set to false to disable offline message limits.</p><p>In response, the server will send back an iq stanza with a result type:</p><pre class="programlisting">&lt;iq type="result" id="${random-id}"&gt;
  &lt;msgoffline xmlns="msgoffline" limit="${limit}"/&gt;
&lt;/iq&gt;</pre><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_example_of_setting_limit_of_stored_offline_messages_to_10"></a>Example of Setting Limit of Stored Offline Messages to 10</h5></div></div></div><p>XMPP client sends the following to the server:</p><pre class="programlisting">&lt;iq type="set" id="aabba"&gt;
  &lt;msgoffline xmlns="msgoffline" limit="10"/&gt;
&lt;/iq&gt;</pre><p>Server response:</p><pre class="programlisting">&lt;iq type="result" id="aabba"&gt;
  &lt;msgoffline xmlns="msgoffline" limit="10"/&gt;
&lt;/iq&gt;</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_example_of_disabling_offline_message_limit"></a>Example of Disabling Offline Message Limit</h5></div></div></div><p>XMPP client sends the following to the server:</p><pre class="programlisting">&lt;iq type="set" id="aabbb"&gt;
  &lt;msgoffline xmlns="msgoffline" limit="false"/&gt;
&lt;/iq&gt;</pre><p>Server response:</p><pre class="programlisting">&lt;iq type="result" id="aabbb"&gt;
  &lt;msgoffline xmlns="msgoffline" limit="false"/&gt;
&lt;/iq&gt;</pre></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="nonBodyElements"></a>Storing offline messages without body content</h3></div></div></div><p>Tigase can now store offline messages without &lt;body/&gt; content.</p><p>See <a class="link" href="http://xmpp.org/extensions/xep-0334.html" target="_top">XEP-0334</a> for protocol details.</p><p>This can include message receipts, and messages with specific <code class="literal">do-not-store</code> tags.</p><p>Support has been added to set a list of paths and xmlns to trigger and place storage of offline messages using the following settings in init.properties:</p><pre class="screen">sess-man/plugins-conf/amp/msg-store-offline-paths[s]=/message/received[urn:xmpp:receipts],/message/store-offline</pre><p>This example results in two settings:</p><p><code class="literal">/message/received[urn:xmpp:receipts]</code></p><p>Results in storage of messages with a <code class="literal">recieved</code> subelement and with the xlmns set to <code class="literal">urn:xmpp:receipts</code></p><p><code class="literal">/message/store-offline</code></p><p>Results in storing messages with a <code class="literal">store-offline</code> subelement without checking xmlns.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="offlineFiltering"></a>Filtering of offline storage</h4></div></div></div><p>It is possible to set storage of other types to save:</p><pre class="programlisting">sess-man/plugins-conf/amp/msg-store-offline-paths[s]=/message/store-offline,-/message/do-not-store</pre><p>The above setting in the init.properties file will do three things:
- Messages with &lt;store-offline&gt; subelement will be stored without checking for associated xmlns.
- Messages with &lt;do-not-store&gt; element <span class="strong"><strong>will not</strong></span> be saved.</p><p>Any of these can be adjusted for your installation, remember that a '-' will stop storage of messages with the indicated property.
Messages will be checked by these matchers and if any of them result in a positive they will override default settings.</p><p>For example, if you wanted to store messages with &lt;received&gt; element, but not ones with &lt;plain&gt; element, your filter will look like this:</p><pre class="programlisting">sess-man/plugins-conf/amp/msg-store-offline-paths[s]=/message/received,-/message/plain</pre><p>However&#8230;&#8203;.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>THE ABOVE STATEMENT WILL NOT WORK As it will just store all messages with &lt;receieved&gt; subelement.</p></div><p>The below statement will properly filter your results.</p><pre class="programlisting">sess-man/plugins-conf/amp/msg-store-offline-paths[s]=-/message/plain,/message/received</pre><p>Filtering logic is done in order from left to right.  Matches on the first statement will ignore or override matches listed afterwards.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="disableOfflineMessages"></a>Disabling Offline Messages</h3></div></div></div><p>If you wish to disable the storing of offline messages, use the following line in your init.properties file.  This will not disable other features of the AMP plugin.</p><pre class="programlisting">sess-man/plugins-conf/amp/msg-offline=false</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="tigase3xconfiguration.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="_using_tigase_applies_to_all_tigase_server_versions.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="licenseserver.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Configuration Wizards&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Licensing</td></tr></table></div></body></html>