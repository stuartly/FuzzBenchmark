<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Tips and Tricks</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="_using_tigase_applies_to_all_tigase_server_versions.html" title="Chapter&nbsp;9.&nbsp;Using Tigase - Applies to All Tigase Server Versions"><link rel="prev" href="watchdog.html" title="Watchdog"><link rel="next" href="commandLineTools2.html" title="Command Line Admin Tools"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Tips and Tricks</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="watchdog.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;9.&nbsp;Using Tigase - Applies to All Tigase Server Versions</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="commandLineTools2.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="tipsAndTricks"></a>Tips and Tricks</h2></div></div></div><p>The section contains some short tricks and tips helping in different kinds of issues related to the server administration and maintenance.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="tipsAndTricks.html#tigaseTip_RuntimeEnvironment" title="Tigase Tip: Checking the Runtime Environment">Runtime Environment Tip</a></li><li class="listitem"><a class="link" href="">Best Practices for Connecting to Tigase XMPP server From Web Browser</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tigaseTip_RuntimeEnvironment"></a>Tigase Tip: Checking the Runtime Environment</h3></div></div></div><p>It has happened recently that we have tried very hard to fix a few annoying problems on one of the Tigase installations. Whatever we did, the problem still existed after uploading a new version and restarting the server. It worked fine in our development environment and it just didn&#8217;t on the target system.</p><p>It turned out that due to specific environment settings on the target system, an old version of Tigase server was always started regardless of what updates uploaded. We finally located the problem by noticing that the logs were not being generated in the proper locations.  This led us to finding the issue: improper environment settings.</p><p>The best way to check all the environment settings used to start the Tigase server is to use&#8230;&#8203;.. <span class="strong"><strong>check</strong></span> command line parameter:</p><pre class="programlisting">./scripts/tigase.sh check etc/tigase.conf
Checking arguments to Tigase
TIGASE_HOME = .
TIGASE_JAR = jars/tigase-server.jar
TIGASE_PARAMS = etc/tigase.conf
TIGASE_CONFIG = etc/tigase.xml
TIGASE_RUN = tigase.server.XMPPServer -c etc/tigase.xml --property-file etc/init.properties
TIGASE_PID = ./logs/tigase.pid
TIGASE_OPTIONS = --property-file etc/init.properties
JAVA_OPTIONS = -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8 \
    -Djdbc.drivers=com.mysql.jdbc.Driver:org.postgresql.Driver \
    -server -Xms100M -Xmx200M -XX:PermSize=32m -XX:MaxPermSize=256m
JAVA = /System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home/bin/java
JAVA_CMD =
CLASSPATH = ./jars/tigase-server.jar:./libs/jdbc-mysql.jar:./libs/jdbc-postgresql.jar:\
    ./libs/tigase-extras.jar:./libs/tigase-muc.jar:./libs/tigase-pubsub.jar:\
    ./libs/tigase-utils.jar:./libs/tigase-xmltools.jar
TIGASE_CMD = /System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home/bin/java \
    -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8 \
    -Djdbc.drivers=com.mysql.jdbc.Driver:org.postgresql.Driver \
    -server -Xms100M -Xmx200M -XX:PermSize=32m -XX:MaxPermSize=256m \
    -cp ./jars/tigase-server.jar:./libs/jdbc-mysql.jar:./libs/jdbc-postgresql.jar:\
    ./libs/tigase-extras.jar:./libs/tigase-muc.jar:./libs/tigase-pubsub.jar:\
    ./libs/tigase-utils.jar:./libs/tigase-xmltools.jar tigase.server.XMPPServer \
    -c etc/tigase.xml --property-file etc/init.properties
TIGASE_CONSOLE_LOG = ./logs/tigase-console.log</pre><p>In our case <span class="strong"><strong>TIGASE_HOME</strong></span> was set to a fixed location pointing to an old version of the server files. The quick <span class="strong"><strong>check</strong></span> command may be a real time saver.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="bestWebPrax"></a>Best Practices for Connecting to Tigase XMPP server From Web Browser</h4></div></div></div><p>Currently we have 2 ways to connect to Tigase XMPP Server from web browsers:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">BOSH (Bidirectional-streams Over Synchronous HTTP)</li><li class="listitem">WebSocket (XMPP over WebSocket)</li></ol></div><p>You will find more informations about these ways for connecting to Tigase XMPP Server with some useful tips below.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_bosh"></a>BOSH</h4></div></div></div><p>BOSH protocol specified in <a class="link" href="http://xmpp.org/extensions/xep-0124.html" target="_top">XEP-0124</a> is one of first protocols defined to allow to establish XMPP connection to XMPP servers from web browsers due to this protocol being widely supported and used. It is also easy to use in single server mode. It&#8217;s enabled by default in Tigase XMPP Server and available at port 5280.</p><p>In clustered mode we can deploy it with load balancer deployed with guarantees that each BOSH connection from web browser will be forwarded to same Tigase XMPP Server instance. So in clustered mode if we have two XMPP server t1 and t2 which are hosting domain example.com we would need to have load balancer which will respond for HTTP request to domain example.com and forward all requests from same IP address to same node of a cluster (i.e. all request from 192.168.122.32 should be forwarded always to node t1.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="tip_1_bosh_in_cluster_mode_without_load_balancer"></a>Tip #1 - BOSH in Cluster Mode Without Load Balancer</h5></div></div></div><p>There is also a way to use BOSH without load balancer enabled. In this case the XMPP client needs to have more logic and knowledge about all available cluster nodes (with names of nodes which will identify particular cluster nodes from internet). Using this knowledge XMPP client should select one random node from list of available nodes and always establish BOSH connections to this particular node. In case if BOSH connection fails due to network connection issues, the XMPP client should randomly pick other node from list of rest of available nodes.</p><p><span class="emphasis"><em>Solution:</em></span></p><p>Tigase XMPP Server by default provides server side solution for this issue by sending additional host attribute in body element of BOSH response. As value of this attribute Tigase XMPP Server sends domain name of server cluster node to which client connected and to which next connections of this session should be opened.
It is possible to disable this custom feature by addition of of following line to etc/init.properties config file:</p><p>bosh/send-node-hostname[B]=false</p><p><span class="emphasis"><em>Example:</em></span></p><p>We have servers t1.example.com and t2.example.com which are nodes of a cluster hosting domain example.com. Web client retrieves list of cluster nodes from web server and then when it needs to connect to the XMPP server it picks random host from list of retrieved cluster nodes (i.e. t2.example.com) and tries to connect using BOSH protocol to host t2.example.com but it should send example.com as name of the server it tries to connect to (example.com should be value of to attribute of XMPP stream).</p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_websocket"></a>WebSocket</h4></div></div></div><p>WebSocket protocol is newly standardized protocol which is supported by many of current versions of browsers. Currently there is a draft of protocol <a class="link" href="https://datatracker.ietf.org/doc/draft-ietf-xmpp-websocket/" target="_top">draft-ietf-xmpp-websocket-00</a> which describes usage of WebSocket to connect to XMPP servers. Tigase XMPP Server implementation of WebSocket protocol to connect to XMPP server is very close to this draft of this specification. By default Tigase XMPP Server has XMPP-over-WebSocket protocol enabled without encryption on port 5290. To use this protocol you need to use library which supports XMPP-ober-WebSocket protocol.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_tip_1_encrypted_websocket_connection"></a>Tip #1 - Encrypted WebSocket Connection</h5></div></div></div><p>It is possible to enable encrypted WebSocket connection in Tigase XMPP Server. To do this you need to add following lines to etc/init.properties config file:</p><pre class="programlisting">ws2s/connections/ports[i]=5290,5291
ws2s/connections/5291/socket=plain
ws2s/connections/5291/type=accept
ws2s/connections/5290/socket=ssl
ws2s/connections/5290/type=accept</pre><p>In this example we enabled WebSocket endpoint on port 5290 allowing unencrypted connections, and encrypted WebSocket endpoint on port 5291.
As this is TLS/SSL connection (no STARTTLS) it uses default certificate installed in Tigase XMPP Server instance. This certificate is located in certs/default.pem.</p><p><span class="strong"><strong>NOTE</strong></span> There is no default configuration for non-default ports.  All ports outside 443 MUST be configured.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_tip_2_encrypted_websocket_connection_dealing_with_multiple_vhosts"></a>Tip #2 - Encrypted WebSocket Connection - Dealing With Multiple VHosts</h5></div></div></div><p>As mentioned in Tip #1 WebSocket endpoint is plain TLS/SSL port, so it always serves default certificate for Tigase XMPP Server instance. That is ok if we are hosting single domain and if default certificate matches matches our domain. But If we host multiple domain we cannot use wss://example1.com:5291/ connection URL, if our default certificate is for domain example2.com. In this situation it is recommended to use the default certificate for the domain under which the server is accessible from the internet. This domain should identify this server, so this domain would not point to two nodes of a cluster. After we deploy separate certificate for each of cluster nodes, we should follow same tip as Tip #1 for BOSH. Our web-based XMPP client should have knowledge about each node of a cluster and when it needs to connect it should randomly select one node from list of available cluster nodes and try to connect using connection URL that would contain name of server under which it can be identified from internet.</p><p><span class="emphasis"><em>Example:</em></span></p><p>We have servers t1.example1.com and t2.example1.com which are nodes of a cluster in hosting domain example2.com. Each of our nodes contains default SSL certificate with domain names matching the cluster node. Web client retrieves list of cluster nodes from web server and then when it needs to connect to XMPP server it picks random host from list of retrieved cluster nodes (i.e. t2.example1.com) and tries to connect using WebSocket encrypted protocol to host t2.example1.com using the following URL: wss://t2.example1.com:5291/. Upon connection the client should still send example2.com as name of server to which it tries to connect (example2.com should be value of to attribute of XMPP stream). This will allow browser to validate certificate as it will be for the same domain to which browser connects, and it will allow XMPP client to connect to domain example2.com, which is one of hosted vhosts.</p></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="watchdog.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="_using_tigase_applies_to_all_tigase_server_versions.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="commandLineTools2.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Watchdog&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Command Line Admin Tools</td></tr></table></div></body></html>