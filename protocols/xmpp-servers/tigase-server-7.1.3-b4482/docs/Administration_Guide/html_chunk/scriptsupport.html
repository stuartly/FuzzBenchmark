<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Scripting support in Tigase</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="_using_tigase_applies_to_all_tigase_server_versions.html" title="Chapter&nbsp;9.&nbsp;Using Tigase - Applies to All Tigase Server Versions"><link rel="prev" href="commandLineTools2.html" title="Command Line Admin Tools"><link rel="next" href="tigase3xconfiguration.html" title="Configuration Wizards"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Scripting support in Tigase</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="commandLineTools2.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;9.&nbsp;Using Tigase - Applies to All Tigase Server Versions</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="tigase3xconfiguration.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="scriptsupport"></a>Scripting support in Tigase</h2></div></div></div><p>Tigase server supports scripting languages in versions 4.3.1 and higher. These pages describe this feature in details how to create new scripts, upload them to the server, and execute them. The guide also contains API description with code examples.</p><p><span class="strong"><strong>PLEASE NOTE</strong></span> Tigase server is known for it very low memory consumption and successfully runs with less then 10MB of RAM memory. However adding scripting support for any non-standard (default) language to Tigase server significantly increases memory requirements for the installation. You cannot expect Tigase server to run on 10MB RAM system if you enabled Python, Scala or any other non-standard language.</p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="scriptingintro"></a>Scripting Introduction - Hello World!</h3></div></div></div><p><span class="inlinemediaobject"><img src="./images/tiger3-small.png" alt="tiger3-small"></span></p><p>This document is the first in a series describing scripting support in the Tigase server showing how to load, install, update and call a script. It contains also an introduction to the scripting API with the first "Hello world!" example.</p><p>Since Tigase version 4.3.1 the server supports scripting for administrator commands as well as standard commands.</p><p>In theory many different languages can be used to write scripts and the only requirement is that support <a class="link" href="http://www.jcp.org/en/jsr/detail?id=223" target="_top">JSR-223</a> for the language is installed. More details can be found on the <a class="link" href="https://scripting.dev.java.net/" target="_top">Java scripting project site</a>.</p><p>In practice some languages are better supported than others, at the moment we recommend <a class="link" href="http://groovy.codehaus.org/" target="_top">Groovy</a>. However the following languages are also confirmed to be working: <a class="link" href="http://www.scala-lang.org/" target="_top">Scala</a>, <a class="link" href="http://www.python.org/" target="_top">Python</a> and <a class="link" href="http://www.ruby-lang.org/en/" target="_top">Ruby</a>. The <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/show/src/main" target="_top">Tigase SVN</a> contains a few examples for these languages.</p><p>Please note, the default Tigase installation contains only libraries for Groovy. Adding support for a different language is as simple as copying a few JAR files to the Tigase <span class="strong"><strong>libs/</strong></span> directory.</p><p>All the examples presented in this guide are also available as ready to use scripts in the Tigase SVN repository in directory: <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/show/src/main/groovy/tigase/admin" target="_top">src/main/groovy/tigase/admin</a>.</p><p>The scripting utilizes only standard XMPP extensions and is by no means specific to any particular solution. We use and prefer Psi client. The whole guide and all the screen-shots are created using Psi client. You can, however, use any other client which supports these extensions as well. As the whole thing is based on the service discovery and ad-hoc commands you need a XMPP client with a good support for both features.</p><p>To follow the guide and run all the examples you need will need to have installed Tigase server version 4.3.1 or newer and you have to connect to the server as administrator.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_loading_script_at_run_time"></a>Loading Script at Run Time</h4></div></div></div><p>All the scripting stuff is usually based on the service discovery and ad-hoc commands in the Tigase server.</p><p><span class="inlinemediaobject"><img src="./images/service-disco.png" alt="service-disco"></span></p><p>The first thing to do, therefore, is to browse service discovery on the running server. The result you receive will depend on your installation and installed components.</p><p>The most interesting things right now are all items with "<span class="strong"><strong><a class="link" href="http://jabber.org/protocol/admin" target="_top">http://jabber.org/protocol/admin</a></strong></span>" in their node part. You may have a few scripts loaded already but there are two commands used for scripting management. Their names are descriptive enough: "<span class="strong"><strong>New command script</strong></span>" and "<span class="strong"><strong>Remove command script</strong></span>".</p><p>The first is for adding a new script or updating existing and the second is for removing script from the server.</p><p>To add a new script you have just to execute "<span class="strong"><strong>New command script</strong></span>". In Psi this is done by double clicking on the element in service discovery list.</p><p><span class="inlinemediaobject"><img src="./images/hello1-new-script.png" alt="hello1-new-script"></span></p><p>The screenshot above shows a couple of options to set for the loaded script:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>Description</strong></span> - is what shows as the script name in the service discovery window. There are no special restrictions on what to put there.</li><li class="listitem"><span class="strong"><strong>Command id</strong></span> - is a unique ID of the script (admin command). This is what shows after the "http://jabber.org/protocol/admin" in node part. This needs to be unique or existing script is overwritten.</li><li class="listitem"><span class="strong"><strong>Language</strong></span> - a drop down list of all supported scripting languages for your installation. Tigase automatically detects all libraries for scripting languages and lists them here. So all you need is to select the correct language for your script.</li><li class="listitem"><span class="strong"><strong>Script text</strong></span> - is just your script content.</li></ul></div><p>When your script is ready and all fields are correctly set, simply press "<span class="strong"><strong>Finish</strong></span>" button and you should receive a message confirming that the script has been loaded successfully.</p><p><span class="inlinemediaobject"><img src="./images/loaded-ok-small.png" alt="loaded-ok-small"></span></p><p>In this guide we are creating a simple "Hello world" script written in Groovy. What it does is displays a window (ad-hoc command result) with a message: "<span class="emphasis"><em>Hello admin, how are you?</em></span>".</p><p>It uses a basic scripting API which is described line by line below:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">It imports basic Tigase classes.</li><li class="listitem">Set&#8217;s a local variable \'p' which points to a \'packet' variable with data received from the client.</li><li class="listitem">Creates a \'res' variable which is response sent back to the client (administrator). The response to the client is of type \'result'. Other possible types will be introduced later.</li><li class="listitem">We operate on ad-hoc commands here so the script uses Tigase utility class to set/retrieve command parameters. It sets the window title and a simple message displayed to the user (administrator).</li><li class="listitem">The last line returns new packet as a script execution result.</li></ol></div><p>The first, very simple version looks like this:</p><pre class="programlisting">import tigase.server.*
def p = (Packet)packet
def res = p.commandResult(Command.DataType.result)
Command.addTitle(res, "Hello World Script")
Command.addInstructions(res, "Hello admin, how are you?")
return res</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_executing_script"></a>Executing Script</h4></div></div></div><p>Once the script is successfully loaded you will have to reload/refresh the service discovery window which now should display one more element on the list.</p><p><span class="inlinemediaobject"><img src="./images/service-disco-with-new-hello.png" alt="service-disco-with-new-hello"></span></p><p>As you can see script name is set to what you have entered as "Description" in script loading window - "<span class="emphasis"><em>Hello world script</em></span>". The command node is set to: "http://jabber.org/protocol/admin#hello" if "<span class="strong"><strong>hello</strong></span>" is what is set as the script ID.</p><p>To execute the script you just have to double click on the script name (or click execute command if you use any other client).</p><p>As a result you should see a simple window similar to the screenshot below displaying our message.</p><p><span class="inlinemediaobject"><img src="./images/hello1-result-small.png" alt="hello1-result-small"></span></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_interaction_in_scripts"></a>Interaction in Scripts</h4></div></div></div><p>Displaying just a message is very nice but is not very useful in most cases. Normally you need to ask the user for some more data or parameters before you can perform any real processing.</p><p>Therefore in most cases the administrator script has to display a new window with input fields asking the user for some more data. In this document we present very simple examples, just an introduction so let&#8217;s ask about the administrator name before displaying a greeting.</p><p><span class="inlinemediaobject"><img src="./images/hello2-asking-for-name-small.png" alt="hello2-asking-for-name-small"></span></p><p>To ask the user for some more information we have to extend example above with some more code:</p><pre class="programlisting">import tigase.server.*

def p = (Packet)packet

def name = Command.getFieldValue(packet, "name")

if (name == null) {
  def res = p.commandResult(Command.DataType.form);
  Command.addTitle(res, "Hello World Script")
  Command.addInstructions(res, "Please provide some details")
  Command.addFieldValue(res, "name", name ?: "", "text-single",
    "Your name")
  return res
}

def res = p.commandResult(Command.DataType.result)
Command.addTitle(res, "Hello World Script")
Command.addInstructions(res, "Hello ${name}, how are you?")

return res</pre><p>If you compare both scripts you see that they are quite similar. Before displaying greeting, however, the script tries to retrieve data from the \'name' input field. If the name had been provided the greeting is displayed, otherwise the script asks for the user name.</p><p><span class="inlinemediaobject"><img src="./images/hello2-result-small.png" alt="hello2-result-small"></span></p><p>Please note, in this case the packet sent back to the user is of type form instead of result. The practical difference is that the type result displays only <span class="strong"><strong>OK</strong></span> button which when pressed doesn&#8217;t send any data to the server. The form packet displays more buttons - <span class="strong"><strong>Finish</strong></span> and <span class="strong"><strong>Cancel</strong></span>. Whichever you press some data is sent back to the server.</p><p>This script demonstrates use of two new methods from the utility class "Command": getFieldValue and addFieldValue.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">The first argument to all Command methods is the packet with ad-hoc command.</li><li class="listitem">The second argument is usually the input field name</li></ul></div><p>These two method parameters are actually enough to read the ad-hoc command data. Methods creating input fields in the ad-hoc command need a few arguments more:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Next arguments sets a default value displayed to the user. The way to it is set in the example above is specific to Groovy language and is quite useful what will be apparent in later examples.</li><li class="listitem">After that we have to specify the field type. All field types are defined in the <a class="link" href="http://xmpp.org/extensions/xep-0004.html#protocol-fieldtypes" target="_top">XEP-0004</a> article.</li><li class="listitem">The last argument specifies the field label which is displayed to the user.</li></ul></div><p><span class="inlinemediaobject"><img src="./images/hello2-new-script.png" alt="hello2-new-script"></span></p><p>There are a few other different utility methods in the Command class to set different types of input fields and they will be described in details later on.</p><p>To reload the script simply call "New command script" again, enter the script text and make sure you entered exactly the same command ID to replace the old script with the new one.</p><p>Or of course, you can enter a new command id to create a new command and make it available on your server.</p><p>When the script is loaded on the server, try to execute it. You should get a new dialog window asking for your name as in the screenshot at the beginning of this section. When you have entered your name and clicked the "Finish" button you will see another window with a greeting message along with your name.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_automatic_scripts_loading_at_startup_time"></a>Automatic Scripts Loading at Startup Time</h4></div></div></div><p>The last thing described in this guide is how to automatically load your scripts when the Tigase server starts. The ability to load scripts at run time, update and remove remove them is very useful, especially in emergency cases if something wrong is going on and you want to act without affecting the service.</p><p>If you, however have a few dozens scripts you don&#8217;t want to manually load them every time the server restarts.</p><p>Tigase server automatically loads all scripts at the startup time which are located in the admin scripts directory. Unless you set it differently in the configuration it is: <span class="strong"><strong>YourTigaseInstallationDir/scripts/admin/</strong></span>. All you have to do is to copy all your scripts to this directory and they will be loaded next time the server starts.</p><p>But hold on. What about the script parameters: language, description, command id? How are you supposed to set them?</p><p>Language is simple. It is detected automatically by the script file extension. So just make sure file extensions are correct and the language is sorted.</p><p>The script description and command id needs a little bit more work. You have to include in your script following lines:</p><pre class="programlisting">AS:Description: The command description
AS:CommandId: command-id
AS:Component: comp_name</pre><p>Please note, there must be at least a single space after the "AS:Description:" or "AS:CommandId:" string. Everything rest after that, until the end of the line, is treated as either the script description or command id. Put these in your script file and the loader will detect them and set correctly for your script.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="newElements"></a>Tigase Scripting Version 4.4.x Update for Administrators</h3></div></div></div><p><span class="inlinemediaobject"><img src="./images/tiger-looking-left-small.png" alt="tiger-looking-left-small"></span></p><p>Scripting functionality is quite useful in Tigase server for all sorts of administrator tasks. The possibility to load new scripts or replace old ones at the server runtime opens quite new area for the service maintenance.</p><p>In earlier versions of the Tigase server scripting capabilities was available only in the session manager component while it might be very useful in many other places - connection managers, MUC, PubSub, VHostManager and what even more important in completely new, custom components created for specific needs. It would be quite wasteful to reinvent the wheel every time and implementing scripting capabilities for each component separately.</p><p>Therefore the scripting capabilities has been implemented in the core of the Tigase server. It is now part of the API and is automatically available to all components without any additional coding. A detailed developer guide will be published separately.</p><p>This document describes changes from the user/administrator perspective because there are some usability changes related to the new implementation.</p><p>Please note. The description and screenshots are taken from the Psi client and most likely interface for ad-hoc commands and service discovery on other client looks different. I recommend to do some initial testing and experiments using Psi client and then switch to your preferred application for your day-to-day use.</p><p>As it always was in the Tigase you can access all the functions via XMPP service discovery on the server. However, as soon as you connect to the server you can see some changes there.</p><p><span class="inlinemediaobject"><img src="./images/new-service-disco-admin.png" alt="new-service-disco-admin"></span></p><p>There are no command on the list. They are hidden from the main service discovery list. You can see on the list only the server main components.</p><p>This had to be done for many reasons. One of them is, obviously, the cleaner access to the main server stuff. Another, probably more important, is to avoid a long list of commands for different components mixed together. Commands for different components can have the same name/description and they can even do similar things but they are executed on a different server component. To avoid any confusion and minimise opportunities for mistake the commands are now closely tight to their components. To access a list of commands for a particular component you have to double click on the component name on the list or click 'Execute command" icon on top of the window when your component is selected.</p><p>A new window should show up with drop-down list of available commands. All the commands are related to the selected component and are executed kind of "inside the component environment". You can of course add new command or delete existing one and of course execute any of the commands showing on the list.</p><p><span class="inlinemediaobject"><img src="./images/new-command-list.png" alt="new-command-list"></span></p><p>As a reminder, in the window title you can see the component ID and you should check it before running any command to make sure you accidentally don&#8217;t break your system.</p><p><span class="inlinemediaobject"><img src="./images/new-add-command.png" alt="new-add-command"></span></p><p>There has been also a small change made to the script adding window. As you can see on the screenshot there is one additional option added - "Save to disk". This means that once you submitted the script to the server it is written to the hard drive and will be automatically loaded at next startup time.</p><p>This option is enabled by default as this seems to be a logical choice that the administrator wants to save his new script for later reuse. This, however requires proper configuration of the server and give writing permission to the directory where all scripts are stored. Otherwise the server won&#8217;t be able to write script files on the hard drive.</p><p>As in previous version only users with administrator permissions can execute commands and access all the critical elements on the server. There has been, however, another change made, long time requested by users. In the new version all the administrator specific elements are hidden for the rest of users.</p><p>Server components don&#8217;t show up on the service discovery, the user can&#8217;t see administrator commands nor he can execute them. This hasn&#8217;t been implemented to improve the server security but to reduce confusion for general users who would otherwise see a lot of stuff which can&#8217;t be used by them anyway.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tigaseandPython"></a>Tigase and Python</h3></div></div></div><p>As I mentioned in <a class="link" href="http://www.tigase.org/content/scripting-introduction-hello-world" target="_top">one of previous articles</a>, Tigase supports virtually any scripting language as long as there is <a class="link" href="http://www.jcp.org/en/jsr/detail?id=223" target="_top">JSR-223</a> support for that language.</p><p>This article describes how to get Python working as a scripting language for ad-hoc commands in Tigase server. The first part is installation, and the second shows a few code examples with explanation of the differences between Python usage and some other languages.</p><p><span class="emphasis"><em>Please note, we are not a Python developer, and by no means this is Python development guide. All the code examples are used only to present the API available and there are certainly better ways to do it in the proper Python style. If you have any suggestions or have a better code examples I am happy to include them in the guide.</em></span></p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_installation_4"></a>Installation</h4></div></div></div><p>In short, installation is extremely simple: just copy the file attached to this article to your Tigase installation, to the libs/ directory. Restart the server and you are ready to start scripting and executing Python.</p><p>In theory the Tigase offers scripting support defined in <a class="link" href="http://www.jcp.org/en/jsr/detail?id=223" target="_top">JSR-223</a>. You can use any language for which there is such support for JVM. This includes also stand-alone python implementations and the JSR-223 plugins acts just as a bridge. This, however, does not make much sense as you are not able to interact with JVM code (Tigase API). Therefore you need a language which is executed within JVM and can easily exchange data between the main application (Tigase server) and the script.</p><p><span class="inlinemediaobject"><img src="./images/lang-list-no-python-small.png" alt="lang-list-no-python-small"></span></p><p>The best way to go is to use Jython implementation. It works very well within JVM and more importantly, perfectly integrates with Tigase server. Tigase server is tested with <span class="strong"><strong>Jython-2.2.1</strong></span> and is confirmed to work fine. Version <span class="strong"><strong>Jython-2.5.1</strong></span> is recommended however, and all the examples are executed with this version installed. Please note, <span class="emphasis"><em>Jython-2.5.0</em></span> does not work at all. Both supported versions can be downloaded from the <a class="link" href="http://wiki.python.org/jython/DownloadInstructions" target="_top">Jython website</a>.</p><p><span class="strong"><strong>Version 2.5.1</strong></span> is a bit simpler to install. When you download and run the Jython installer, find jython.jar file in the directory where you installed Jython. Copy the file to the Tigase&#8217;s <span class="strong"><strong>libs/</strong></span> directory and all is ready to go. Please note, this is the same file as the one attached to this article for your convenience.</p><p><span class="strong"><strong>Version 2.2.1</strong></span> needs a little bit more work. The first part is the same. It is not, however enough to copy the jython.jar file. One more file is necessary for the Jython to work with the Tigase server. You have to install JSR-223 engine separately which can be downloaded from the <a class="link" href="https://scripting.dev.java.net/" target="_top">Java scripting project website</a>. The binary file has to be unpacked and jython-engine.jar file needs to be copied to the Tigase libs/ directory.</p><p>The best way to check if the Jython is installed correctly and support for Python is enabled, is by trying to submit a new script to the Tigase server. Browser the server service discovery, select "<span class="emphasis"><em>Session manager</em></span>" component and run "<span class="emphasis"><em>Execute command</em></span>" function. A new window should show with a list of all available ad-hoc commands. Select "<span class="emphasis"><em>New command script</em></span>" item and click "<span class="emphasis"><em>Execute</em></span>". Ad-hoc command dialog windows should show up. One of the field is "<span class="emphasis"><em>Language</em></span>" with pull down list of available scripting languages. If "<span class="emphasis"><em>python</em></span>" is on the list it means everything is ok and support for Python is enabled.</p><p><span class="inlinemediaobject"><img src="./images/lang-list-with-python-small.png" alt="lang-list-with-python-small"></span></p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_writing_python_scripts"></a>Writing Python Scripts</h4></div></div></div><p>Python scripts work in a similar way to Groovy or other languages scripts, except one significant difference. You cannot call "<span class="emphasis"><em>return</em></span>" from the script itself. Hence you cannot simply pass script results by calling "<span class="emphasis"><em>return</em></span>" statement directly from the script.</p><p>To overcome the problem, Tigase offers another way to pass script execution results. It checks the value of a special variables on the script completion: "result" and "packet". By assigning value to one of these variables the Python (or any other language) can pass execution results back to the Tigase server.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">"result" allows to return simple text (or characters String) from the script.</li><li class="listitem">"packet" allows to return Packet instance which is send back to the user.</li></ul></div><p>The simplest possible Python script may look like this one:</p><p>result = "Hello world!"</p><p>For instructions how to load and execute the script, please refer to the <a class="link" href="scriptsupport.html#scriptingintro" title="Scripting Introduction - Hello World!">introductory article</a> for scripting in Tigase server. There were some minor changes in Tigase 4.4.0 and later versions, so please have a look at the <a class="link" href="scriptsupport.html#newElements" title="Tigase Scripting Version 4.4.x Update for Administrators">article</a> describing new elements as well.</p><p>An example of a more advanced script asks the user for providing required parameters for the actual script execution:</p><pre class="programlisting">from java.lang import *
from tigase.server import *

num1 = Command.getFieldValue(packet, "num1")
num2 = Command.getFieldValue(packet, "num2")

if num1 is None or num2 is None:
  res = Iq.commandResultForm(packet)
  Command.addTextField(res, "Note", "This is a Python script!")
  Command.addFieldValue(res, "num1", "")
  Command.addFieldValue(res, "num2", "")
  packet = res
else:
  result = num1 + num2</pre><p>Except this minor difference, the rest part of scripting in Python for the Tigase administrator commands is the same as all other languages. As all languages can return execution results via these special variables, it could be argued there is no difference at all.</p><p><a class="link" href="http://docs.tigase.org/tigase-server/snapshot/Development_Guide/html_chunk/cil6.html" target="_top">In another article</a>, I am going to present the Tigase server API available for scripting framework. My main language is Groovy as it offers the best integration with JVM and Tigase API, however I will try to include Python example code as well.</p><p>I hope this article encourages you to try the scripting support in the Tigase server. If you have any suggestions or questions please do not hesitate to send me your comments. I have also created a new <a class="link" href="http://www.tigase.org/forums/tigase-scripts" target="_top">tigase scripts</a> forum on the website. If you have an interesting script to share or want to discuss some aspects of this functionality do not hesitate to add your post.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="files/jython-2.5.1.jar" target="_top">jython-2.5.1.jar</a> 6.44 MB</li></ul></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="commandLineTools2.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="_using_tigase_applies_to_all_tigase_server_versions.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="tigase3xconfiguration.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Command Line Admin Tools&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Configuration Wizards</td></tr></table></div></body></html>