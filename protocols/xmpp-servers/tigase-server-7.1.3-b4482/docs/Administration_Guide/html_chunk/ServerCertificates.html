<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Server Certificates</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="_security_2.html" title="Chapter&nbsp;6.&nbsp;Security"><link rel="prev" href="_security_2.html" title="Chapter&nbsp;6.&nbsp;Security"><link rel="next" href="customAuthentication.html" title="Custom Authentication Connectors"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Server Certificates</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_security_2.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;6.&nbsp;Security</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="customAuthentication.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ServerCertificates"></a>Server Certificates</h2></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="ServerCertificates.html#certspem" title="Creating and Loading the Server Certificate in pem Files">Creating and Loading the Server Certificate in pem Files</a></li><li class="listitem"><a class="link" href="">Installing StartCom Certificate in Your Linux System</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="certspem"></a>Creating and Loading the Server Certificate in pem Files</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_server_certificates"></a>Server Certificates</h4></div></div></div><p>Server certificates are needed when you use secure socket connections - SSL/TLS.</p><p>For secure socket connection a proper certificate is needed. You can either generate your own self-signed certificate or obtain certificate from trusted third party organization.</p><p>Here are steps how to obtain certificate from a trusted organization.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_generating_your_own_certificates"></a>Generating your Own Certificates</h5></div></div></div><p>Self-signed certificates can be generated easily on a Linux system.  Although it may not be considered a 'trusted' certificate authority, it can be useful to test server installations.  <span class="strong"><strong>We do not recommend regular use of self-signed certificates</strong></span>.</p><p>Note that Tigase v5.0 and later can automatically create self signed PEM files if needed.  However we will cover doing this process by hand.</p><p>This tutorial assumes you are running a Linux-based operating system with access to command shell, and the 'Openssl' package is installed on the system.</p><p>The process takes the following steps:
1. Create a local private key.  This file ends with .key extension.  It is recommended to create a new private key for the process.
2. Generate a certificate request.  This file ends with the .csr extension and is the file sent to the Certificate Authority to be signed.
3. CA signs private key.  This can be done by your own computer, but can also be done by private CAs for a fee.
4. Results are obtained from the CA.  This is a .crt file which contains a separate public certificate.
5. Combine the .csr and .crt file into a unified .pem file.  Tigase requires keys to be non-password protected PEM files.</p><p><b>Generate local private key.&nbsp;</b>
</p><pre class="programlisting">openssl genrsa -out[domain.com.key] 1024</pre><p>
</p><p>This command generates a private key using a 1024 bit RSA algorithm.  -out designates the name of the file, in this case it will be <span class="strong"><strong>domain.com.key</strong></span>. The exact name is not important, and the file will be created in whatever directory you are currently in.</p><p><b>Generate a certificate request:&nbsp;</b>
</p><pre class="programlisting">openssl req -nodes -key domain.com.key -out domain.com.csr</pre><p>
</p><p>This command generates a certificate request using the file specified after -key, and the result file will be domain.com.csr.  You will be asked a series of questions to generate the request.</p><pre class="programlisting">Country Name (2 letter code) [AU]:AU
State or Province Name (full name) [Some-State]:Somestate
Locality Name (eg, city) []:Your city name
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Company name
Organizational Unit Name (eg, section) []:Department or any unit
Common Name (eg, YOUR name) []:*.yourdomain.com
Email Address []:your_email_address@somedomain.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:</pre><p><b>Sign the Certificate Request:&nbsp;</b>Now the .csr file will be signed by a Certificate Authority.  In this tutorial, we will be self-signging our certificate.  This practice however is generally not recommended, and you will receive notifications that your certificate is not trusted.  There are commercial offers from companies to sign your certificate from trusted sources.  Please see the <a class="link" href="ServerCertificates.html#OtherSources" title="Certificate From Other Providers">Certificate From Other Providers</a> section for more information.</p><pre class="programlisting">openssl x509 -req -days 365 -in domain.com.csr -signkey domain.com.key -out domain.com.crt</pre><p>This command signs the certificate for 365 days and generates the domain.com.crt file. You can, of course use any number of days you like.</p><p><b>Generate PEM file.&nbsp;</b>You should now have the following files in the working directory:
..\
domain.com.key
domain.com.csr
domain.com.crt</p><pre class="programlisting">cat yourdomain.com.crt yourdomain.com.key &gt; yourdomain.com.pem</pre><p>If the certificate is issued by third-party authority you will have to attach the certificate chain, that being certificate of the authority who has generated your certificate. You normally need to obtain certificates for your chain from the authority who has generated your certificate. For example, if you have a certificate from XMPP federation you need to download <a class="link" href="http://www.startssl.com/certs/ca.pem" target="_top">StartCom root certificate</a> <span class="strong"><strong>and</strong></span> <a class="link" href="http://www.startssl.com/certs/sub.class1.server.ca.pem" target="_top">intermediate ICA certificate</a>. In such cases the pem file is created using following command:</p><pre class="programlisting">cat yourdomain.com.crt yourdomain.com.key sub.class1.xmpp.ca.crt ca.crt &gt; yourdomain.com.pem</pre><p>The result file should looks similar to:</p><pre class="programlisting">-----BEGIN CERTIFICATE-----
MIIG/TCCBeWgAwIBAgIDAOwZMA0GCSqGSIb3DQEBBQUAMIGMMQswCQYDVQQGEwJJ
.
.
.
pSLqw/PmSLSmUNIr8yQnhy4=
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
WW91J3JlIGtpZGRpbmchISEKSSBkb24ndCBzaG93IHlvdSBvdXIgcHJpdmF0ZSBr
.
.
.
ZXkhISEhCkNyZWF0ZSB5b3VyIG93biA7KSA7KSA7KQo=
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIHyTCCBbGgAwIBAgIBATANBgkqhkiG9w0BAQUFADB9MQswCQYDVQQGEwJJTDEW
.
.
.
xV/stleh
-----END CERTIFICATE-----</pre><p>For Tigase server as well as many other servers (Apache 2.x), the order is following; your domain certificate, your private key, authority issuing your certificate, root certificate.</p><p><span class="strong"><strong>Note! Tigase requires full certificate chain in PEM file (described above)! Different applications may require pem file with certificates and private key in different order. So the same file may not be necessarily used by other services like Web server or e-mail server. Currently, Tigase can automatically sort certificates in PEM file while loading it.</strong></span></p></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_installing_loading_certificate_to_the_tigase_server"></a>Installing/Loading Certificate To the Tigase Server</h4></div></div></div><p>From version <span class="strong"><strong>3.1.0-b802</strong></span> of Tigase server, installing and loading certificates is very easy. The server can load all certificates directly from <span class="strong"><strong>pem</strong></span> files. You just need to create a separate pem file for each of your virtual domains and put the file in a directory accessible by the server. Tigase server can automatically load all <span class="strong"><strong>pem</strong></span> files found in given directory.  By default, and to make things easy, we recommend the Tigase/certs directory.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="OtherSources"></a>Certificate From Other Providers</h4></div></div></div><p>There is number of certificate providers offering certificates either for free or for money. You can use any of them, however you have to be aware that sometimes certificates might not be recognized by all XMPP servers, especially if it&#8217;s one from a new provider. Here is an example list of providers:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="https://www.cacert.org/" target="_top">CAcert</a> - free certificates with an excellent Web GUI for managing generated certificates and identities.</li><li class="listitem"><a class="link" href="https://www.startssl.com/" target="_top">StartCom</a> - both free and paid certificates, class 1, 2 and 3. Very good GUI for managing certificates and identities.</li><li class="listitem"><a class="link" href="https://www.verisign.com/" target="_top">Verisign</a> - very expensive certificates comparing to above provides but the provider is recognized by everybody. If you have a certificate from Verisign you can be sure it is identified as a valid certificate.</li><li class="listitem"><a class="link" href="http://www.comodo.com/business-security/digital-certificates/ssl-certificates.php" target="_top">Comodo Certificate Authority</a> offers different kind of commercial certificates</li></ul></div><p>To obtain certificate from a third party authority you have to go to its website and request the certificate using certificate request generated above. I cannot provide any instructions for this as each of the providers listed have different requirements and interfaces.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="onecertmultipledomain"></a>Using one certificate for multiple domains</h4></div></div></div><p>By default, each virtual hosts will require it&#8217;s own certificate.  However, if you choose to use one certificate for all virtual hosts, Tigase supports that option.
For example, if you have host1.example.net, host2.example.net, and host3.example.net each vhost will need some configuration:</p><pre class="programlisting">basic-conf/virtual-hosts-cert-host1.example.net=/home/tigase/certs/host1.pem
basic-conf/virtual-hosts-cert-host2.example.net=/home/tigase/certs/host2.pem
basic-conf/virtual-hosts-cert-host3.example.net=/home/tigase/certs/host3.pem</pre><p>This may be time consuming if you have many Vhosts, or expect to generate many more.  The good news is, now one certificate can be used for ALL Vhosts using the following configuration line:</p><pre class="programlisting">basic-conf/virt-hosts-cert-*.example.net=/home/tigase/certs/certificate.pem</pre><p>Now any Vhosts created will use the same certificate located at /home/tigase/certs/certificate.pem. <span class="strong"><strong>NOTE:</strong></span> This is an all or nothing option, if you wish to customize each Vhost, you will need to do so individually.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_tigase_server_configuration_for_5_1_0_and_older"></a>Tigase Server Configuration for 5.1.0 and older</h4></div></div></div><p>Starting from version 5.1.0 and newer it&#8217;s not needed to use external libraries nor extra configuration in the init.properties file. With this version Tigase uses, loaded by default thus no need to configure it, following class:</p><pre class="programlisting">--ssl-container-class=tigase.io.SSLContextContainer</pre><p>Older versions require different configurations. In order to be able to load server certificates directly from <span class="strong"><strong>pem</strong></span> files you need to have <span class="strong"><strong>tigase-extras</strong></span> package installed in your server <span class="strong"><strong>libs/</strong></span> directory in version at least <span class="strong"><strong>0.1.0</strong></span>. If you use a Tigase server binary package other than <span class="strong"><strong>mini</strong></span>, this library is included by default. If you haven&#8217;t changed anything in your XML configuration file, put following line in your initial.properties file:</p><pre class="programlisting">--ssl-container-class=tigase.extras.io.PEMSSLContextContainer</pre><p>Copy all your <span class="strong"><strong>pem</strong></span> files with certificates into certs/ subdirectory in Tigase server installation, stop the server, remove XML configuration file and start the server. XML configuration will be automatically regenerated with the new SSLContainer used by all components and all certificates will be automatically loaded.</p><p>If you have changed your XML configuration file, and do not want to lose those changes, you will now have to manually change the existing SSLContainer class with the new one. Just replace all occurrences of the default SSLContainer - tigase.io.SSLContextContainer with the new - tigase.extras.io.PEMSSLContextContainer, copy all your <span class="strong"><strong>pem</strong></span> files with certificates into certs/ subdirectory in Tigase server installation and restart the server.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="LetsEncryptCertificate"></a>Installing LetsEncrypt Certificates in Your Linux System</h3></div></div></div><p>LetsEncrypt is a trusted CA that provides free security certificates.  Unlike previously self-signed certificates, we can use LetsEncrypt Certificates to certify your domains from a trusted source.
To do this, remote into the server hosting Tigase, or login to the computer locally and begin to install git if that is not already on the system.</p><pre class="programlisting">sudo apt-get install git</pre><p>Once the machine installs git, use the following command to download the LetsEncrypt Tools.</p><pre class="programlisting">sudo git clone https://github.com/letsencrypt/letsencrypt /opt/letsencrypt</pre><p>This will download the tools into the computers' /opt/letsencrypt directory.  You will now need to generate the certificates using this tool using the next command.</p><pre class="programlisting">sudo -H ./letsencrypt-auto certonly --standalone -d domain.com</pre><p>where domain.com is your currently hosted domain.  Be sure that port 443 is forwarded to this computer, and that proper A and DNS records are registered for your domain.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Note</h3><p>Letsencrypt does not allow for wildcards in the domain name, you will need to generate certificates for each subdomain you wish certified by the CA.</p></div><p>Those certificates will be created and will be stored in <span class="emphasis"><em>/etc/letsencrypt/live/$domain</em></span> and you will need admin privladges to see them.</p><pre class="programlisting">sudo -i
**********
cd /etc/letsencrypt/live/$domain

ls

cert.pem chain.pem fullchain.pem privkey.pem</pre><p>In that directory, you will find four certificates:
- cert.pem
- chain.pem
- fullchain.pem
- privkey.pem</p><p>For Tigase, we are only concerned with privkey.pem contents.  Copy that certificate to another directory.</p><pre class="programlisting">cp privkey.pem /home/user</pre><p>At this point we will need to obtain the root and intermediate certificates, this can be done by downloading these certificates from the <a class="link" href="https://letsencrypt.org/certificates/" target="_top">LetsEncrypt website</a>.</p><p>Alternatively, you may obtain them using wget:</p><pre class="programlisting">wget https://letsencrypt.org/certs/isrgrootx1.pem
wget https://letsencrypt.org/certs/letsencryptauthorityx3.pem</pre><p>These are the root certificate, and the intermediate certificate signed by root certificate.
NOTE: IdenTrust cross-signed certificate will not function properly.</p><p>Take the contents of your privkey.pem, and combine them with the contents of isrgrootx1.pem and letsencryptauthorityx3.pem into a single pem certificate.  You may wish to name the file after your domain such as mydomain.com.pem.
Your certificate should look something like this:</p><pre class="programlisting">-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDAUAqqKu7Z4odo
...
og89F9AbWr1mNmyRoScyqMXo
-----END PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
cmNoIEdyb3VwMRUwEwYDVQQDEwxJU1JHIFJvb3QgWDEwHhcNMTUwNjA0MTEwNDM4
...
TzELMAkGA1UEBhMCVVMxKTAnBgNVBAoTIEludGVybmV0IFNlY3VyaXR5IFJlc2Vh
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
FhpodHRwOi8vY3BzLmxldHNlbmNyeXB0Lm9yZzCBqwYIKwYBBQUHAgIwgZ4MgZtU
...
bmcgUGFydGllcyBhbmQgb25seSBpbiBhY2NvcmRhbmNlIHdpdGggdGhlIENlcnRp
-----END CERTIFICATE-----</pre><p>Place that certificate into your /certs folder of Tigase, and installation of this certificate is done.</p><p>You will need to do this for all subdomains you wish to have a certificate for, however, you may be able to import the root and intermediate certificates to your keystore to avoid having to paste the chain certificates for each subdomain.</p><div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Warning</h3><p>LetsEncrypt certificates expire 90 days from issue and need to be renewed in order for them to remain valid!</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_including_letsencrypt_cert_pem"></a>Including letsencrypt cert.pem</h4></div></div></div><p>For some installations, you may need to also include the cert.pem contents into your certificate chain to avoid handshake errors.  You will then have 4 certificates in your domain.com.pem file.
Be sure the order is as follows: cert.pem, privkey.pem, isgrootx1.pem, then letsencryptauthorityx3.pem</p><p>If you moved all certs to a single directry, you may combine them using the following command in a *nix operating system.</p><pre class="programlisting">cat ./cert.pem ./privkey.pem ./letsencryptauthorityx3.pem ./isrgrootx1.pem &gt; mydomain.com.pem</pre></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_security_2.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="_security_2.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="customAuthentication.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;6.&nbsp;Security&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Custom Authentication Connectors</td></tr></table></div></body></html>