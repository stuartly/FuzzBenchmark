<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Custom Authentication Connectors</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="_security_2.html" title="Chapter&nbsp;6.&nbsp;Security"><link rel="prev" href="ServerCertificates.html" title="Server Certificates"><link rel="next" href="tigase41packetFiltering.html" title="Packet Filtering"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Custom Authentication Connectors</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="ServerCertificates.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;6.&nbsp;Security</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="tigase41packetFiltering.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="customAuthentication"></a>Custom Authentication Connectors</h2></div></div></div><p>This article presents configuration options available to the administrator and describe how to set Tigase server up to use user accounts data from a different database.</p><p>The first thing to know is that Tigase server always opens 2 separate connections to the database. One connection is used for user login data and the other is for all other user data like the user roster, vCard, private data storage, privacy lists and so on&#8230;&#8203;</p><p>In this article we still assume that Tigase server keeps user data in it&#8217;s own database and only login data is retrieved from the external database.</p><p>At the moment Tigase offers following authentication connectors:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">'mysql', 'pgsql', 'derby' - standard authentication connector used to load user login data from the main user database used by the Tigase server. In fact the same physical implementation is used for all JDBC databases.</li><li class="listitem">'drupal' - is the authentication connector used to integrate the Tigase server with <a class="link" href="http://drupal.org/" target="_top">Drupal CMS</a>.</li><li class="listitem">'libresource' - is the authentication connector used to integrate the Tigase server with <a class="link" href="http://dev.libresource.org/" target="_top">Libresource Collaboration platform</a>.</li><li class="listitem">'tigase-auth' - is the authentication connector which can be used with any database. It executes stored procedures to perform all actions. Therefore it is a very convenient way to integrate the server with an external database if you don&#8217;t want to expose the database structure. You just have to provide a set of stored procedures in the database. While implementing all stored procedures expected by the server might be a bit of work it allows you to hide the database structure and change the SP implementation at any time. You can add more actions on user login/logout without restarting or touching the server. And the configuration on the server side is very simple. For detailed description of this implementation please refer to <a class="link" href="customAuthentication.html#tigaseAuthConnector" title="Tigase Auth Connector">Tigase Auth documentation</a>.</li><li class="listitem">'tigase-custom' - is the authentication connector which can be used with any database. Unlike the 'tigase-auth' connector it allows you to define SQL queries in the configuration file. The advantage of this implementation is that you don&#8217;t have to touch your database. You can use either simple plain SQL queries or stored procedures. The configuration is more difficult as you have to enter carefully all SQL queries in the config file and changing the query usually involves restarting the server. For more details about this implementation and all configuration parameters please refer to <a class="link" href="customAuthentication.html#custonAuthConnector" title="Tigase Custom Auth Connector">Tigase Custom Auth documentation</a>.</li></ul></div><p>As always the simplest way to configure the server is through the init.properties file. In the article describing this file you can find long list with all available options and all details how to handle it. For the authentication connector setup however we only need 2 options:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">'--auth-db = connector'</li><li class="listitem">'--auth-db-uri = database connection url'</li></ul></div><p>If you happen to keep the user data in the same database as user authentication data you can even skip the second parameter as Tigase automatically assumes settings from the '--user-db-uri' it '--auth-db-uri' is missing.</p><p>'--auth-db-uri' stored a standard JDBC connection URL and is exactly the same as for all other settings. For example if you store authentication data in a 'drupal' database on 'localhost' the URL might look like:</p><pre class="programlisting">--auth-db-uri = jdbc:mysql://localhost/drupal?user=user&amp;password=passwd</pre><p>'--auth-db' stored just a connector name or connector implementation class. For convenience Tigase has predefined short names for the most common connectors but you can always use the class name if you know it. You have to use a class name if you want to attach your own authentication connector. The following 2 settings are equal:</p><pre class="programlisting">--auth-db = tigase-auth</pre><pre class="programlisting">--auth-db = tigase.db.jdbc.TigaseAuth</pre><p>In the same exact way you can setup connector for any different database type:</p><pre class="programlisting">--auth-db = drupal</pre><pre class="programlisting">--auth-db = tigase-custom</pre><p>You can normally skip configuring connectors for the default Tigase database format: 'mysql', 'pgsql' and 'derby' as they are applied automatically if the parameter is missing.</p><p>One more important thing to know is that you will have to modify '--user-db-uri' if you use a custom authentication connector. This is because if you retrieve user login data from the external database this external database is usually managed by an external system. User accounts are added without notifying Tigase server. Then, when the user logs in and tries to retrieve the user roster, the server can not find such a user in the roster database.</p><p>To keep user accounts in sync between the authentication database and the main user database you have to add following option to the end of the database connection URL: 'autoCreateUser=true'.</p><p>For example:</p><pre class="programlisting">--user-db-uri=jdbc:mysql://localhost/tigasedb?user=nobody&amp;password=pass&amp;autoCreateUser=true</pre><p>If you are interested in even further customizing your authentication connector by writing your own queries or stored procedures, please have a look at 2 following guides:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><a class="link" href="customAuthentication.html#tigaseAuthConnector" title="Tigase Auth Connector">Tigase Auth guide</a></li><li class="listitem"><a class="link" href="customAuthentication.html#custonAuthConnector" title="Tigase Custom Auth Connector">Tigase Custom Auth guide</a></li></ul></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="tigaseAuthConnector"></a>Tigase Auth Connector</h3></div></div></div><p>The Tigase Auth connector with shortcut name: <span class="strong"><strong>tigase-auth</strong></span> is implemented in the class: <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/changes/src/main/java/tigase/db/jdbc/TigaseAuth.java" target="_top">tigase.db.jdbc.TigaseAuth</a>. It allows you to connect to any external database to perform user authentication.
You can find more details how to setup a custom connector in the <a class="link" href="">Custom Authentication Connectors</a> guide.</p><p>To make this connector working you have to prepare your database to offer set of stored procedures for Tigase server to perform all the authentication actions. The best description is the example schema with all the stored procedures defined. Please refer to the Tigase <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/show/database" target="_top">SVN repository</a> for the schema definition files.</p><p>Files with the stored procedures implementations are located in <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/show/database" target="_top">postgresql-schema-4.sql</a> file for PostgreSQL database.</p><p>The absolute minimum of stored procedures you have to implement is:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>TigUserLoginPlainPw</strong></span> - to perform user authentication. The procedure is always called when the user tries to login to the XMPP server. This is the only procedure which must be implemented and actually must work.</li><li class="listitem"><span class="strong"><strong>TigUserLogout</strong></span> - to perform user logout. The procedure is always called when the user logouts or disconnects from the server. This procedure must be implemented but it can be empty and can do nothing. It just needs to exist because Tigase expect it to exist and attempts to call it.</li></ul></div><p>With these 2 above stored procedures you can only perform user login/logouts on the external database. You can&#8217;t register a user account, change user password or remove the user. In many cases this is fine as all the user management is handled by the external system.</p><p>If you however want to allow for account management via XMPP you have to implement also following procedures:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>TigAddUserPlainPw</strong></span> - to add a new user account</li><li class="listitem"><span class="strong"><strong>TigRemoveUser</strong></span> - to remove existing user account</li><li class="listitem"><span class="strong"><strong>TigUpdatePasswordPlainPw</strong></span> - to change a user password for existing account</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="custonAuthConnector"></a>Tigase Custom Auth Connector</h3></div></div></div><p>The Tigase Custom Auth connector with shortcut name: <span class="strong"><strong>tigase-custom</strong></span> is implemented in the class: <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/changes/src/main/java/tigase/db/jdbc/TigaseCustomAuth.java" target="_top">tigase.db.jdbc.TigaseCustomAuth</a>. It allows you to connect to any external database to perform user authentication and use a custom queries for all actions.</p><p>You can find more details how to setup a custom connector in the Custom Authentication Connectors guide.</p><p>The basic configuration is very simple:</p><pre class="programlisting">--auth-db = tigase-custom
--auth-db-uri = jdbc:mysql://localhost/drupal?user=user&amp;password=passwd</pre><p>That&#8217;s it.</p><p>The connector loads correctly and starts working using predefined, default list of queries. In most cases you also might want to define your own queries in the configuration file. The shortest possible description is the following example of the content from the init.properties file:</p><pre class="programlisting"># This query is used to check connection to the database, whether it is still alive or not
basic-conf/auth-repo-params/conn-valid-query=select 1

# This is database initialization query, normally we do not use it, especially in
# clustered environment
basic-conf/auth-repo-params/init-db-query=update tig_users set online_status = 0

# Below query performs user authentication on the database level.
# The Tigase server does not need to know authentication algorithm or password
# encoding type, it simply passes user id (BareJID) and password in form
# which was received from the client, to the stored procedure. If the
# authentication was successful the procedure returns user bare JID or null otherwise.
# The Tigase checks whether the JID returned from the query matches
# JID passed as a parameter. If they match, the authentication is successful.
basic-conf/auth-repo-params/user-login-query={ call TigUserLoginPlainPw(?, ?) }

# Below query returns number of user accounts in the database, this is mainly used
# for the server metrics and monitoring components.
basic-conf/auth-repo-params/users-count-query={ call TigAllUsersCount() }

# Below query is used to add a new user account to the database
basic-conf/auth-repo-params/add-user-query={ call TigAddUserPlainPw(?, ?) }

# Below query is used to remove existing account with all user's data from the database
basic-conf/auth-repo-params/del-user-query={ call TigRemoveUser(?) }

# This query is used for the user authentication if "user-login-query" is not defined,
# that is if there is no database level user authentication algorithm available. In such
# a case the Tigase server loads user's password from the database and compares it
# with data received from the client.
basic-conf/auth-repo-params/get-password-query=select user_pw from tig_users where user_id = ?

# Below query is used for user password update in case user decides to change his password
basic-conf/auth-repo-params/update-password-query=update tig_users set user_pw = ? where user_id = ?

# Below query is called on user logout event. Usually we use a stored procedure which
# records user logout time and marks user as offline in the database
basic-conf/auth-repo-params/user-logout-query=update tig_users, set online_status = online_status - 1 where user_id = ?

# This is configuration setting to specify what non-sasl authentication mechanisms
# expose to the client
basic-conf/auth-repo-params/non-sasl-mechs=password,digest

# This is configuration setting to specify what sasl authentication mechanisms expose to the client
basic-conf/auth-repo-params/sasl-mechs=PLAIN,DIGEST-MD5</pre><p>Queries are defined in the configuration file and they can be either plain SQL queries or stored procedures. If the query starts with characters: '\{ call' then the server assumes this is a stored procedure call, otherwise it is executed as a plain SQL query. Each configuration value is stripped from white characters on both ends before processing.</p><p>Please don&#8217;t use semicolon ';' at the end of the query as many JDBC drivers get confused and the query may not work.</p><p>Some queries can take arguments. Arguments are marked by question marks '?' in the query. Refer to the configuration parameters description for more details about what parameters are expected in each query.</p><p>The first example shows how to put a stored procedure as a query with 2 required parameters.</p><pre class="programlisting">add-user-query={ call TigAddUserPlainPw(?, ?) }</pre><p>The same query with plain SQL parameters instead:</p><pre class="programlisting">add-user-query=insert into users (user_id, password) values (?, ?)</pre><p>The order of the query arguments is important and must be exactly as described in specification for each parameter.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">'conn-valid-query' - Query executing periodically to ensure active connection with the database.</p><p class="simpara">Takes no arguments.</p><p class="simpara">Example query: 'select 1'</p></li><li class="listitem"><p class="simpara">'init-db-query' - Database initialization query which is run after the server is started.</p><p class="simpara">Takes no arguments.</p><p class="simpara">Example query: 'update tig_users set online_status = 0'</p></li><li class="listitem"><p class="simpara">'add-user-query' - Query adding a new user to the database.</p><p class="simpara">Takes 2 arguments: (user_id (JID), password)</p><p class="simpara">Example query: 'insert into tig_users (user_id, user_pw) values (?, ?)'</p></li><li class="listitem"><p class="simpara">'del-user-query' - Removes a user from the database.</p><p class="simpara">Takes 1 argument: (user_id (JID))</p><p class="simpara">Example query: 'delete from tig_users where user_id = ?'</p></li><li class="listitem"><p class="simpara">'get-password-query' - Retrieves user password from the database for given user_id (JID).</p><p class="simpara">Takes 1 argument: (user_id (JID))</p><p class="simpara">Example query: 'select user_pw from tig_users where user_id = ?'</p></li><li class="listitem"><p class="simpara">'update-password-query' - Updates (changes) password for a given user_id (JID).</p><p class="simpara">Takes 2 arguments: (password, user_id (JID))</p><p class="simpara">Example query: 'update tig_users set user_pw = ? where user_id = ?'</p></li><li class="listitem"><p class="simpara">'user-login-query' - Performs user login. Normally used when there is a special SP used for this purpose. This is an alternative way to a method requiring retrieving user password. Therefore at least one of those queries must be defined: user-login-query or get-password-query.</p><p class="simpara">If both queries are defined then user-login-query is used. Normally this method should be only used with plain text password authentication or sasl-plain.</p><p class="simpara">Tigase expects a result set with user_id to be returned from the query if login is successful and empty results set if the login is unsuccessful.</p><p class="simpara">Takes 2 arguments: (user_id (JID), password)</p><p class="simpara">Example query: 'select user_id from tig_users where (user_id = ?) AND (user_pw = ?)'</p></li><li class="listitem"><p class="simpara">'user-logout-query' - This query is called when user logs out or disconnects. It can record that event in the database.</p><p class="simpara">Takes 1 argument: (user_id (JID))</p><p class="simpara">Example query: 'update tig_users, set online_status = online_status - 1 where user_id = ?'</p></li><li class="listitem">'non-sasl-mechs' - Comma separated list of NON-SASL authentication mechanisms. Possible mechanisms are: password and digest. The digest mechanism can work only with get-password-query active and only when password are stored in plain text format in the database.</li><li class="listitem"><p class="simpara">'sasl-mechs' - Comma separated list of SASL authentication mechanisms. Possible mechanisms are all mechanisms supported by Java implementation. The most common are: PLAIN, DIGEST-MD5, CRAM-MD5.</p><p class="simpara">"Non-PLAIN" mechanisms will work only with the get-password-query active and only when passwords are stored in plain text format in the database.   Application: Tigase Server</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="drupalAuthentication"></a>Drupal Authentication</h3></div></div></div><p>Currently, we can only check authentication against a <span class="strong"><strong>Drupal</strong></span> database at the moment. Full <span class="strong"><strong>Drupal</strong></span> authentication is not implemented as of yet.</p><p>As <span class="strong"><strong>Drupal</strong></span> keeps encrypted passwords in database the only possible authorization protocols are those based on PLAIN passwords.</p><p>To protect your passwords <span class="strong"><strong>Tigase</strong></span> server must be used with SSL or TLS encryption.</p><p>Implementation of a <span class="strong"><strong>Drupal</strong></span> database based authorization is located in tigase.db.jdbc.DrupalAuth class. Although this class is capable of adding new users to the repository I recommend to switch in-band registration off due to the caching problems in <span class="strong"><strong>Drupal.</strong></span> Changes in database are not synchronized with <span class="strong"><strong>Drupal</strong></span> yet. Functionality for adding new users is implemented only to ease user accounts migration from different repository types from earlier <span class="strong"><strong>Tigase</strong></span> server installations.</p><p>The purpose of that implementation was to allow all accounts administration tasks from <span class="strong"><strong>Drupal</strong></span> like: account creation, all accounts settings, like e-mail, full name, password changes and so on.</p><p><span class="strong"><strong>Tigase</strong></span> server uses following fields from <span class="strong"><strong>Drupal</strong></span> database: name (user account name), pass (user account password), status (status of the account). Server picks up all changes instantly. If user status is not 1 then server won&#8217;t allow user to login trough XMPP even if user provides valid password.</p><p>There is no <span class="emphasis"><em>Roster</em></span> management in <span class="strong"><strong>Drupal</strong></span> yet. So Roster management have to be done from the XMPP client.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="LDAPauth"></a>LDAP Authentication Connector</h3></div></div></div><p>From version 5.1.0, rev. (build) 2881 Tigase XMPP Server offers support for authenticating users against an LDAP server in <span class="strong"><strong>Bind</strong></span> <span class="strong"><strong>Authentication</strong></span> mode.</p><p>Configuration for the LDAP support is really simple you just have to add a few lines to your init.properties file.</p><pre class="programlisting"># LDAP Authentication connector
--auth-db = tigase.db.ldap.LdapAuthProvider
# LDAP connection URI
--auth-db-uri=ldap://ldap.tigase.com:389
# LDAP access parameters
basic-conf/auth-repo-params/user-dn-pattern=cn=USER_ID,ou=people,dc=tigase,dc=org</pre><p>Please note the <span class="strong"><strong>USER_ID</strong></span> element, this is a special element of the configuration which is used to authenticate particular user. Tigase LDAP connector replaces it with appropriate data during authentication. You can control what Tigase should put into this part. In your configuration you must replace this string with one of the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><span class="strong"><strong>%1$s</strong></span> - use user name only for authentication (JabberID&#8217;s localpart)</li><li class="listitem"><span class="strong"><strong>%2$s</strong></span> - use domain name only for authentication (JabberID&#8217;s domain part)</li><li class="listitem"><span class="strong"><strong>%3$s</strong></span> - use the whole Jabber ID (JID) for authentication</li></ol></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="saslExternal"></a>Configuration of SASL EXTERNAL</h3></div></div></div><p>In order to enable SASL External add following line to the  init.properties file</p><pre class="programlisting">c2s/clientCertCA=/path/to/cacert.pem</pre><p>File cacert.pem contains Certificate Authority certificate which is used to sign clients certificate.</p><p>Client certificate must include user&#8217;s Jabber ID as XmppAddr in subjectAltName:</p><div class="blockquote"><blockquote class="blockquote"><p>As specified in RFC 3920 and updated in RFC 6120, during the stream negotiation process an XMPP client can present a certificate (a &#8220;client certificate&#8221;). If a JabberID is included in a client certificate, it is encapsulated as an id-on-xmppAddr Object Identifier (&#8220;xmppAddr&#8221;), i.e., a subjectAltName entry of type otherName with an ASN.1 Object Identifier of &#8220;id-on-xmppAddr&#8221; as specified in Section 13.7.1.4 of RFC 6120.<a href="#ftn.d0e4380" class="footnote" name="d0e4380"><sup class="footnote">[1]</sup></a></p></blockquote></div><p>It is possible to make client certificate required:</p><pre class="programlisting">c2s/clientCertRequired[B]=true</pre><p>If this option will be enabled, then client must provide certificate. This certificate will be verified against c2s/clientCertCA. If client does not provide certificate or certificate will be invalid, TLS handshake will be interrupted and client will be disconnected.</p><p>Using this options does not force client to use SASL EXTERNAL. Client still may authenticate with other SASL mechanisms.</p></div><div class="footnotes"><br><hr style="width:100; text-align:left;margin-left: 0"><div id="ftn.d0e4380" class="footnote"><p><a href="#d0e4380" class="simpara"><sup class="simpara">[1] </sup></a><a class="link" href="http://xmpp.org/extensions/xep-0178.html#c2s" target="_top">XEP-0178</a></p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ServerCertificates.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="_security_2.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="tigase41packetFiltering.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Server Certificates&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Packet Filtering</td></tr></table></div></body></html>