<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Database Preparation</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="databasemgnt.html" title="Chapter&nbsp;7.&nbsp;Database Management"><link rel="prev" href="databasemgnt.html" title="Chapter&nbsp;7.&nbsp;Database Management"><link rel="next" href="hashedPasswords.html" title="Hashed User Passwords in Database"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Database Preparation</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="databasemgnt.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;7.&nbsp;Database Management</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="hashedPasswords.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="databasePreperation"></a>Database Preparation</h2></div></div></div><p>Tigase uses generally the same database schema and the same set of stored procedures and functions on every database. However, the schema creation scripts and code for stored procedures is different for each database. Therefore the manual process to prepare database is different for each database system.</p><p>Of course the simplest and easiest way to prepare database is to use Tigase installer or webinstaller which automates the whole process. Sometimes this is not possible. A second option is to use the DBSchemaLoader utility in Tigase. If either of those won&#8217;t work, or won&#8217;t suit your needs,  provided are set of guides describing initialization and preparation process for each supported database.</p><p>-<a class="link" href="databasePreperation.html#dbSchemaLoader" title="dbSchemaLoader Utility">The DBSchemaLoader Utility</a>
- <a class="link" href="databasePreperation.html#prepareMysql" title="Prepare the MySQL Database for the Tigase Server">Prepare the MySQL Database for the Tigase Server</a>
- <a class="link" href="hashedPasswords.html" title="Hashed User Passwords in Database">Hashed User Passwords in Database</a>
- <a class="link" href="databasePreperation.html#prepareDerby" title="Prepare the Derby Database for the Tigase Server">Prepare the Derby Database for the Tigase Server</a>
- <a class="link" href="databasePreperation.html#prepareMssql" title="Prepare the MS SQL Server Database for the Tigase Server">Prepare the MS SQL Server Database for the Tigase Server</a>
- <a class="link" href="databasePreperation.html#preparePostgresql" title="Prepare the PostgreSQL Database for the Tigase Server">Prepare the PostgreSQL Database for the Tigase Server</a></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="dbSchemaLoader"></a>dbSchemaLoader Utility</h3></div></div></div><p>Included with Tigase is the dbSchemaLoader Utility, which can be used to apply schema files to databases. It is able to operate with Derby, MySQL, SQLServer, and PostgreSQL databases.
In order to use this utility with any of the databases, you will need to first have the database environment up and running, and have established user credentials. You may use root or an account with administrator write privileges.</p><div class="important" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Important</h3><p>All commands in this guide are required to be running from the Tigase installation directory.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_operation_variables"></a>Operation &amp; Variables</h4></div></div></div><p>First, lets cover the DBSchemaLoader operation and variables:</p><p><span class="strong"><strong>Operation</strong></span>
The utility is run using the java -cp command from the Tigase installation directory.  Be sure that you have JDK v1.8 or later installed.
Linux</p><pre class="programlisting">java -cp "jars/*" tigase.util.DBSchemaLoader</pre><p>or from a Windows environment</p><pre class="screen">java -cp jars/* tigase.util.DBSchemaLoader</pre><p>These commands will be followed by a combination of the following variables</p><p><span class="strong"><strong>Variables</strong></span></p><div class="variablelist"><dl class="variablelist"><dt><span class="term">Use the following options to customize. Options in bold are required, {potential options are in brackets}.</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>-dbType database_type {derby, mysql, postgresql, sqlserver}</strong></span></li><li class="listitem">-schemaVersion schema version {4, 5, 5-1}</li><li class="listitem"><span class="strong"><strong>-dbName database name</strong></span></li><li class="listitem">-dbHostname database hostname (default is localhost)</li><li class="listitem">-dbUser tigase username</li><li class="listitem">-dbPass tigase user password</li><li class="listitem">-rootUser database root username</li><li class="listitem">-rootPass database root password</li><li class="listitem"><span class="strong"><strong>-file path to sql schema file</strong></span> {database/derby-schema-7-1.sql}</li><li class="listitem">-query sql query to execute</li><li class="listitem">-logLevel java logger Level</li><li class="listitem">-adminJID comma separated list of admin JIDs</li><li class="listitem">-adminJIDpass password (one for all entered JIDs)</li></ul></div></dd></dl></div><p>With that out of the way, lets look at some examples.
Lets say you have a new mysql database server with root user root and password rood (to keep things simple, we do not recommend this).  The MySQL database is hosted locally, your command would be as follows:</p><pre class="programlisting">java -cp "jars/*" tigase.util.DBSchemaLoader -dbType mysql -dbName tigasedb -rootUser root -rootPass root -schemaVersion -adminJID admin@example.com -adminJIDpass password 7.1 -file database/mysql-schema-7-1.sql</pre><p>This will create the tigasedb database, add an Admin user as <a class="link" href="mailto:admin@example.com" target="_top">admin@example.com</a> with password 'password', and apply the v7.1 schema files. Output will look like this:</p><pre class="programlisting">LogLevel: CONFIG

tigase.util.DBSchemaLoader     	 &lt;init&gt;          	 CONFIG     Properties: [{dbHostname=localhost, logLevel=CONFIG, adminJID=admin@example.com, dbType=mysql, file=database/mysql-schema-7-1.sql, rootUser=root, adminJIDpass=password, dbPass=tigase_pass, dbName=tigasedb, schemaVersion=7.1, rootPass=root, dbUser=tigase_user}]

tigase.util.DBSchemaLoader     	 validateDBConnection 	 INFO       Validating DBConnection, URI: jdbc:mysql://localhost/?user=root&amp;password=root

tigase.util.DBSchemaLoader     	 validateDBConnection 	 CONFIG     DriverManager (available drivers): [[org.apache.derby.jdbc.AutoloadedDriver@10f87f48, org.postgresql.Driver@1b2c6ec2, com.mysql.jdbc.Driver@50040f0c, jTDS 1.3.1]]

tigase.util.DBSchemaLoader     	 validateDBConnection 	 INFO       Connection OK
tigase.util.DBSchemaLoader     	 validateDBExists 	 INFO       Validating whether DB Exists, URI: jdbc:mysql://localhost/tigasedb?user=tigase_user&amp;password=tigase_pass

tigase.util.DBSchemaLoader     	 validateDBExists 	 INFO       Doesn't exist, creating...

tigase.util.DBSchemaLoader     	 validateDBExists 	 INFO        OK

tigase.util.DBSchemaLoader     	 loadSchemaFile  	 INFO       Loading schema from file: database/mysql-schema-7-1.sql, URI: jdbc:mysql://localhost/tigasedb?user=root&amp;password=root
tigase.util.DBSchemaLoader     	 loadSchemaFile  	 INFO        completed OK

tigase.util.DBSchemaLoader     	 printInfo       	 INFO

Database init.properties configuration:

--user-db=mysql
--user-db-uri=jdbc:mysql://localhost/tigasedb user=tigase_user&amp;password=tigase_pass&amp;useUnicode=true&amp;characterEncoding=UTF-8</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Tip</h3><p>The utility will automatically generate the lines you need to add to your init.properties file to use this database!</p></div><p>At this time, it is suggested to load the PubSub schema since you will have to change very little of the command:</p><pre class="programlisting">java -cp "jars/*" tigase.util.DBSchemaLoader -dbType mysql -dbName tigasedb -rootUser root -rootPass root -file database/mysql-pubsub-schema-3.2.0.sql</pre><p>Should you wish to use the Socks5 Proxy component, you will need to load that schema as well</p><pre class="programlisting">java -cp "jars/*" tigase.util.DBSchemaLoader -dbType mysql -dbName tigasedb -rootUser root -rootPass root -file database/mysql-socks5-schema.sql</pre><p>At this time you&#8217;re finished setting up a database for use with Tigase!
For other databases that are supported, the operations will be very similar with only the -dbType and perhaps the -dbHostname being different.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__query_function"></a>-Query function</h4></div></div></div><p>Should you decide to customize your own functions, or have specific information you want to put into the database, you can use the -query function to perform a single query step.</p><pre class="programlisting">java -cp "jars/*" tigase.util.DBSchemaLoader -dpType mysql -dbName tigasedb -rootUser root -rootPass root -query "CREATE TABLE tigasedb.EXTRA_TABLE (id INT(6) UNSIGNED AUTO_INCREMENT PRIMARY KEY, name VARCHAR(10) NOT NULL)"</pre><p>Of course this would break the schema for tigasedb by adding an unexpected table,  you will receive the following message:</p><pre class="screen">tigase.util.DBSchemaLoader       printInfo          WARNING       Database schema is invalid</pre><p>But this is a demonstration how you may run a query through the database without the need to use another tool.  Note that you will need to select the specific database for each query.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="prepareMysql"></a>Prepare the MySQL Database for the Tigase Server</h3></div></div></div><p>This guide describes how to prepare MySQL database for connecting Tigase server.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_basic_setup"></a>Basic Setup</h4></div></div></div><p>The MySQL database can be prepared in many ways. Most Linux distributions contain tools which allow you to go through all steps from the shell command line. To make sure it works on all platforms in the same way, we will first show how to do it under MySQL command line client.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_configuring_from_mysql_command_line_tool"></a>Configuring from MySQL command line tool</h5></div></div></div><p>Run the MySQL command line client in either Linux or MS Windows environment and enter following instructions:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Create the database for the Tigase server:</p><pre class="programlisting">mysql&gt; create database tigasedb;</pre></li><li class="listitem"><p class="simpara">Add the tigase_user user and grant him access to the tigasedb database. Depending on how you plan to connect to the database (locally or over the network) use one of following commands or all if you are not sure:</p><p class="simpara"><span class="strong"><strong>Grant access to tigase_user connecting from any network address.</strong></span></p><pre class="programlisting">mysql&gt; GRANT ALL ON tigasedb.* TO tigase_user@'%'
            IDENTIFIED BY 'tigase_passwd';</pre><p class="simpara"><span class="strong"><strong>Grant access to tigase_user connecting from localhost.</strong></span></p><pre class="programlisting">mysql&gt; GRANT ALL ON tigasedb.* TO tigase_user@'localhost'
            IDENTIFIED BY 'tigase_passwd';</pre><p class="simpara"><span class="strong"><strong>Grant access to tigase_user connecting from local machine only.</strong></span></p><pre class="programlisting">mysql&gt; GRANT ALL ON tigasedb.* TO tigase_user
            IDENTIFIED BY 'tigase_passwd';</pre><p class="simpara">For the Tigase server version 4.x additional permissions must be granted for the database user:</p><pre class="programlisting">mysql&gt; GRANT SELECT, INSERT, UPDATE ON mysql.proc TO 'tigase_user'@'localhost';
mysql&gt; GRANT SELECT, INSERT, UPDATE ON mysql.proc TO 'tigase_user'@'%';
mysql&gt; GRANT SELECT, INSERT, UPDATE ON mysql.proc TO 'tigase_user';</pre><p class="simpara">And now you can update user permission changes in the database:</p><pre class="programlisting">mysql&gt; FLUSH PRIVILEGES;</pre></li><li class="listitem"><p class="simpara">Load the proper mysql schema into the database.  Full installations of Tigase will have all the SQL file you need to create and update the database. First, switch to the database you have just created:</p><pre class="programlisting">mysql&gt; use tigasedb;</pre><p class="simpara">We are assuming you run the mysql client in Linux from the Tigase installation directory.</p><pre class="programlisting">mysql&gt; source database/mysql-7-1-schema.sql;</pre><p class="simpara">For the Tigase server version v7.1.0 you have to use proper schema version which is 5.1.  You will also need to manually load the PubSub schema as well, current version is v3.2.0.  All modern versions will load previous schemas first so no need to do a manual upgrade.</p><pre class="programlisting">mysql&gt; source database/mysql-pubsub-schema-3.2.0.sql;</pre><p class="simpara">If you plan to use the Socks5 component, you will also need to add that schema as well.</p><pre class="programlisting">mysql&gt; source database/mysql-socks5-schema.sql;</pre><p class="simpara">On Windows you have probably to enter the full path, assuming Tigase is installed in C:\Program Files\Tigase:</p><pre class="programlisting">mysql&gt; source c:/Program Files/Tigase/database/mysql-7-1-schema.sql;
mysql&gt; source c:/Program Files/Tigase/database/mysql-pubsub-schema-3.2.0.sql;
mysql&gt; source c:/Program Files/Tigase/database/mysql-socks5-schema.sql;</pre></li></ol></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_from_the_linux_shell_command_line"></a>Configuring From the Linux Shell Command Line</h4></div></div></div><p>Follow steps below to prepare the MySQL database:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Create the database space for the Tigase server:</li></ol></div><pre class="screen">mysqladmin -p create tigasedb</pre><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Add the tigase_user user and grant access to the tigasedb database. Depending on how you plan to connect to the database (locally or over the network) use one of following commands or all if you are not sure:
<span class="strong"><strong>Grant access to tigase_user connecting from any network address.</strong></span></li></ol></div><pre class="screen">echo "GRANT ALL ON tigasedb.* TO tigase_user@'%' \
            IDENTIFIED BY 'tigase_passwd'; \
            FLUSH PRIVILEGES;" | mysql -u root -pdbpass mysql</pre><p><span class="strong"><strong>Grant access to tigase_user connecting from localhost.</strong></span></p><pre class="programlisting">echo "GRANT ALL ON tigasedb.* TO tigase_user@'localhost' \
            IDENTIFIED BY 'tigase_passwd'; \
            FLUSH PRIVILEGES;" | mysql -u root -pdbpass mysql</pre><p><span class="strong"><strong>Grant access to tigase_user connecting from local machine only.</strong></span></p><pre class="programlisting">echo "GRANT ALL ON tigasedb.* TO tigase_user \
            IDENTIFIED BY 'tigase_passwd'; \
            FLUSH PRIVILEGES;" | mysql -u root -pdbpass mysql</pre><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Load the proper mysql schema into the database.  Full installations of Tigase will have all the SQL file you need to create and update the database.</li></ol></div><pre class="screen">mysql -u dbuser -p tigasedb &lt; mysql-schema-7-1.sql
mysql -u dbuser -p tigasedb &lt; mysql-pubsub-schema-3.2.0.sql</pre><p>If you want to use the socks5 component, then oyu will need to include the following line as well:</p><pre class="programlisting">mysql -u dbuser -p tigasedb &lt; mysql-socks5-schema.sql</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_mysql_for_utf_8_support"></a>Configuring MySQL for UTF-8 Support</h4></div></div></div><p>In my.conf put following lines:</p><pre class="programlisting">[mysql]
default-character-SET=utf8

[client]
default-character-SET=utf8

[mysqld]
init_connect='SET collation_connection = utf8_general_ci; SET NAMES utf8;'
character-set-server=utf8
default-character-SET=utf8
collation-server=utf8_general_ci
skip-character-set-client-handshake</pre><p>Then connect to the database from the command line shell check settings:</p><pre class="programlisting">SHOW VARIABLES LIKE 'character_set_database';
SHOW VARIABLES LIKE 'character_set_client';</pre><p>If any of these shows something else then 'utf8' then you need to fix it using the command:</p><pre class="programlisting">ALTER DATABASE tigasedb DEFAULT CHARACTER SET utf8;</pre><p>You can now also test your database installation if it accepts UTF-8 data. The easiest way to ensure this is to just to create an account with UTF-8 characters:</p><pre class="programlisting">call TigAddUserPlainPw('&#380;&oacute;&#322;w@some.domain.com', '&#380;&oacute;&#322;w');</pre><p>And then check that the account has been created:</p><pre class="programlisting">SELECT * FROM tig_users WHERE user_id = '&#380;&oacute;&#322;w@some.domain.com';</pre><p>If the last command gives you no results it means there is still something wrong with your settings. You might also want to check your shell settings to make sure your command line shell supports UTF-8 characters and passes them correctly to MySQL:</p><pre class="programlisting">export LANG=en_US.UTF-8
export LOCALE=UTF-8
export LESSCHARSET='utf-8'</pre><p>It seems that MySQL 5.0.x also needs extra parameters in the connection string: '&amp;useUnicode=true&amp;characterEncoding=UTF-8' while MySQL 5.1.x seems to not need it but it doesn&#8217;t hurt to have it for both versions. You have to edit 'etc/init.properties' file and append this to the database connection string.</p><p>For MySQL 5.1.x, however, you need to also update code for all database stored procedures and functions used by the Tigase. They are updated for Tigase version 4.4.x and up, however if you use an older version of the Tigase server, you can reload stored procedures using the file from SVN.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_other_mysql_settings_worth_considering"></a>Other MySQL Settings Worth Considering</h4></div></div></div><p>There are a number of other useful options, especially for performance improvements. Please note, you will have to review them as some of them may impact data reliability and are useful for performance or load tests installations only.</p><pre class="programlisting"># InnoDB seems to be a better choice
# so lets make it a default DB engine
default-storage-engine = innodb</pre><p>Some the general MySQL settings which mainly affect performance:</p><pre class="programlisting">key_buffer = 64M
max_allowed_packet = 32M
sort_buffer_size = 64M
net_buffer_length = 64K
read_buffer_size = 16M
read_rnd_buffer_size = 16M
thread_stack = 192K
thread_cache_size = 8
query_cache_limit = 10M
query_cache_size = 64M</pre><p>InnoDB specific settings:</p><pre class="programlisting"># Keep data in a separate file for each table
innodb_file_per_table = 1
# Allocate memory for data buffers
innodb_buffer_pool_size = 1000M
innodb_additional_mem_pool_size = 100M
# A location of the MySQL database
innodb_data_home_dir = /home/databases/mysql/
innodb_log_group_home_dir = /home/databases/mysql/
# The main thing here is the 'autoextend' property
# without it your data file may reach maximum size and
# no more records can be added to the table.
innodb_data_file_path = ibdata1:10M:autoextend
innodb_log_file_size = 10M
innodb_log_buffer_size = 32M
# Some other performance affecting settings
innodb_flush_log_at_trx_commit = 2
innodb_lock_wait_timeout = 50
innodb_thread_concurrency = 16</pre><p>These settings may not be fully optimized for your system, and have been only tested on our systems. If you have found better settings for your systems, feel free to <a class="link" href="http://tigase.net/contact" target="_top">let us know</a>.</p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="prepareDerby"></a>Prepare the Derby Database for the Tigase Server</h3></div></div></div><p>This guide describes how to prepare Derby database for connecting the Tigase server.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_basic_setup_2"></a>Basic Setup</h4></div></div></div><p>Preparation of Derby database is quite simple, but the following assumptions are made</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">DerbyDB - Derby database name</li><li class="listitem">database/ directory contains all necessary schema files</li><li class="listitem">jars/ and libs/ directories contains Tigase and Derby binaries</li></ul></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_general_approach"></a>General Approach</h5></div></div></div><p>From the main Tigase directory execute following commands (Linux and Windows accordingly)</p><p><span class="strong"><strong>Linux</strong></span></p><pre class="programlisting">java -Dij.protocol=jdbc:derby: -Dij.database="DerbyDB;create=true" -cp libs/derby.jar:libs/derbytools.jar:jars/tigase-server.jar org.apache.derby.tools.ij database/derby-schema-7.1.sql</pre><p><span class="strong"><strong>Windows</strong></span></p><pre class="programlisting">java -Dij.protocol=jdbc:derby: -Dij.database="DerbyDB;create=true" -cp libs\derby.jar;libs\derbytools.jar;jars\tigase-server.jar org.apache.derby.tools.ij "database\derby-schema-7-1.sql"</pre><p>This will create Derby database named DerbyDB in the main Tigase directory and load Tigase schema for version 7.1.</p><p>You will need to repeat this process again to add the PubSub schema into the database.</p><p><span class="strong"><strong>Linux</strong></span></p><pre class="programlisting">java -Dij.protocol=jdbc:derby: -Dij.database="DerbyDB;create=true" -cp libs/derby.jar:libs/derbytools.jar:jars/tigase-server.jar org.apache.derby.tools.ij database/derby-pubsub-schema-3.2.0.sql</pre><p><span class="strong"><strong>Windows</strong></span></p><pre class="programlisting">java -Dij.protocol=jdbc:derby: -Dij.database="DerbyDB;create=true" -cp libs\derby.jar;libs\derbytools.jar;jars\tigase-server.jar org.apache.derby.tools.ij "database\derby-pubsub-schema-3.2.0.sql"</pre><p>If you wish to use the Sock5 Proxy Component, you will need to add that schema as well:</p><p><span class="strong"><strong>Linux</strong></span></p><pre class="programlisting">java -Dij.protocol=jdbc:derby: -Dij.database="DerbyDB;create=true" -cp libs/derby.jar:libs/derbytools.jar:jars/tigase-server.jar org.apache.derby.tools.ij database/derby-socks5-schema.sql</pre><p><span class="strong"><strong>Windows</strong></span></p><pre class="programlisting">java -Dij.protocol=jdbc:derby: -Dij.database="DerbyDB;create=true" -cp libs\derby.jar;libs\derbytools.jar;jars\tigase-server.jar org.apache.derby.tools.ij "database\derby-socks5-schema.sql"</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_connecting_tigase_to_database"></a>Connecting Tigase to database</h4></div></div></div><p>Once the database is setup, configure the init.properties file in Tigase and add the following configuration:</p><pre class="programlisting">jdbc:derby:{location of derby database};</pre></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="prepareMssql"></a>Prepare the MS SQL Server Database for the Tigase Server</h3></div></div></div><p>This guide describes how to prepare the MS SQL Server database for connecting the Tigase server to it.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_basic_setup_3"></a>Basic Setup</h4></div></div></div><p>It&#8217;s expected that a working installation of Microsoft SQL Server is present. The following guide will describe the necessary configurations required for using MS SQL Server with Tigase XMPP Server.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_preparing_ms_sql_server_instance"></a>Preparing MS SQL Server Instance</h4></div></div></div><p>After installation of MS SQL Server an instance needs to be configure to handle incoming JDBC connections. For that purpose it&#8217;s required to open <span class="emphasis"><em>SQL Server Configuration Manager</em></span>. In the left-hand side panel navigate to <span class="emphasis"><em>SQL Server Configuration Manager</em></span>, then <span class="emphasis"><em>SQL Server Network Configuration &#8594; Protocols for ${INSTANCE_NAME}</em></span>. After selecting instance in the right-hand side panel select TCP/IP and open <span class="emphasis"><em>Properties</em></span>, in the Protocol tab in General section select Yes for Enabled property. In the IP Addresses tab select Yes for Active and Enabled properties of all IP Addresses that you want MS SQL Server to handle. Subsequently set the TCP Port property (if missing) to the default value - 1433. A restart of the instance may be required afterwards.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuration_using_ms_sql_server_management_studio"></a>Configuration using MS SQL Server Management Studio</h4></div></div></div><p>In order to prepare the database you can use either a wizard or execute queries directly in the Query Editor. Firstly you need to establish a connection to the MS SQL Server instance. From Object Explorer select Connect and in the Connect to Server dialog enter administrator credentials.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_using_wizards"></a>Using Wizards</h5></div></div></div><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Create Login</p><p class="simpara">In the left-hand side panel select Security &#8594; Logins and from context menu choose New Login, in the Wizard window enter desired Login name, select SQL Server authentication and enter desired password subsequently confirming action with OK</p></li><li class="listitem"><p class="simpara">Create Database</p><p class="simpara">From the Object Explorer select Databases node and from context menu select New Database; in the Wizard window enter desired Database name and enter previously created Login name into Owner field; subsequently confirming action with OK.</p></li></ul></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_using_queries"></a>Using Queries</h5></div></div></div><p>From the Object Explorer root node&#8217;s context menu select New Query. In the Query windows execute following statements adjusting details to your liking:</p><pre class="programlisting">USE [master]
GO

CREATE DATABASE [tigasedb];
GO

CREATE LOGIN [tigase] WITH PASSWORD=N'tigase12', DEFAULT_DATABASE=[tigasedb]
GO

ALTER AUTHORIZATION ON DATABASE::tigasedb TO tigase;
GO</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_import_schema"></a>Import Schema</h4></div></div></div><p>From the File menu Select Open &#8594; File (or use Ctrl+O) and then open following files:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">sqlserver-schema-7-1-schema.sql</li><li class="listitem">sqlserver-schema-7-1-sp.sql</li><li class="listitem">sqlserver-schema-7-1-props.sql</li><li class="listitem">sqlserver-pubsub-schema-3.2.0.sql</li></ul></div><p>Subsequently select created database from the list of Available Databases (Ctrl+U) available on the toolbar and execute each of the opened files in the order listed above.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuring_from_command_line_tool"></a>Configuring from command line tool</h4></div></div></div><p>Creation of the database and import of schema can be done from command line as well. In order to do that, execute following commands from the directory where Tigase XMPP Server is installed otherwise paths to the schema need to be adjusted accordingly:</p><pre class="programlisting">sqlcmd -S %servername% -U %root_user% -P %root_pass% -Q "CREATE DATABASE [%database%]"
sqlcmd -S %servername% -U %root_user% -P %root_pass% -Q "CREATE LOGIN [%user%] WITH PASSWORD=N'%password%', DEFAULT_DATABASE=[%database%]"
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -Q "ALTER AUTHORIZATION ON DATABASE::%database% TO %user%;"
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -i database\sqlserver-schema-7-1-schema.sql
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -i database\sqlserver-schema-7-1-sp.sql
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -i database\sqlserver-schema-7-1-props.sql
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -i database\sqlserver-pubsub-schema-3.2.0.sql</pre><p>Above can be automatized with provided script %tigase-server%\scripts\db-create-sqlserver.cmd (note: it needs to be executed from main Tigase XMPP Server directory due to maintain correct paths):</p><pre class="programlisting">$ scripts\db-create-sqlserver.cmd %database_servername% %database_name% %tigase_username% %tigase_password% %root_username% %root_password%</pre><p>If no parameters are provided then the following defaults are used:</p><pre class="programlisting">%database_servername%=localhost
%database_name%=tigasedb
%tigase_username%=tigase
%tigase_password%=tigase12
%root_username%=root
%root_password%=root</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_tigase_configuration_init_properties"></a>Tigase configuration - init.properties</h4></div></div></div><p>Configuration of the MS SQL Server follows general database convention. For MS SQL Support --user-db needs to be set to sqlserver:</p><pre class="programlisting">--user-db=sqlserver</pre><p>and the --user-db-uri needs to point to the configured database:</p><pre class="programlisting">--user-db-uri=jdbc:[jtds:]sqlserver://db_hostname:port[;property=val]</pre><p>where any number of additional parameters can (and should) consist of:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">databaseName - name of the database</li><li class="listitem">user - username configured to access database</li><li class="listitem">password - password for the above username</li><li class="listitem">schema - name of the database schema</li><li class="listitem">lastUpdateCount - 'false' value causes all update counts to be returned, including those returned by server triggers</li></ul></div><p>Example:</p><pre class="programlisting">--user-db-uri=jdbc:sqlserver://hostname:1433;databaseName=tigasedb;user=tigase;password=tigase12;schema=dbo;lastUpdateCount=false</pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_jdbc_jtds_vs_ms_jdbc_driver"></a>JDBC: jTDS vs MS JDBC driver</h4></div></div></div><p>Tigase XMPP Server supports two JDBC drivers intended to be used with Microsoft SQL Server - one created and provided by Microsoft itself and the alternative implementation - jTDS. Tigase is shipped with the latter in the distribution packages. Starting with the version 7.1.0 we recommend using jDTS driver that is shipped with Tigase as JDBC driver created by Microsoft can cause problems with some components in cluster installations. MS driver can be downloaded form the website: <a class="link" href="http://www.microsoft.com/en-us/download/details.aspx?displaylang=en&amp;id=11774" target="_top">JDBC Drivers 4.0, 4.1 for SQL Server</a> then unpack the archive. Copy sqljdbc_4.0/enu/sqljdbc4.jar file to ${tigase-server}/jars directory.</p><p>Depending on the driver used --user-db-uri needs to be configured accordingly.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">Microsoft driver:</p><pre class="programlisting">--user-db-uri=jdbc:sqlserver://...</pre></li><li class="listitem"><p class="simpara">jDTS driver</p><pre class="programlisting">--user-db-uri=jdbc:jdts:sqlserver://...</pre></li></ul></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="preparePostgresql"></a>Prepare the PostgreSQL Database for the Tigase Server</h3></div></div></div><p>This guide describes how to prepare PostgreSQL database for connecting to Tigase server.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_basic_setup_4"></a>Basic Setup</h4></div></div></div><p>The PostgreSQL database can be prepared in many ways. Below are presented two possible ways. The following assumptions apply to both methods:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">admin_db_user - database user with admin rights</li><li class="listitem">tigase_user - database user for Tigase</li><li class="listitem">tigasedb - database for Tigase</li></ul></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_configuring_from_postgresql_command_line_tool"></a>Configuring from PostgreSQL Command Line Tool</h5></div></div></div><p>Run the PostgreSQL command line client and enter following instructions:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Add the tigase_user:</p><pre class="programlisting">psql=# create role tigase_user with login password 'tigase123';</pre></li><li class="listitem"><p class="simpara">Create the database for the Tigase server with tigase_user as owner of database:</p><pre class="programlisting">psql=# create database tigasedb owner tigase_user;</pre></li><li class="listitem"><p class="simpara">Load database schema to initialize the Tigase server from the file that corresponds to the version of Tigase you want to use. First you need to switch to tigasedb.</p><pre class="programlisting">psql=# \connect tigasedb</pre><p class="simpara">Begin by applying the basic Schema</p><pre class="programlisting">psql=# \i database/postgresql-schema-7-1.sql</pre><p class="simpara">Continue by adding the PubSub Schema</p><pre class="programlisting">psql=# \i database/postgresql-pubsub-schema-3.2.0.sql</pre><p class="simpara">And finally if you wish to use Socks5 Proxy component, add that schema:</p></li></ol></div><pre class="screen">psql=# \i database/postgresql-socks5-schema.sql</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_configuring_from_the_linux_shell_command_line_2"></a>Configuring From the Linux Shell Command Line</h5></div></div></div><p>Follow steps below to prepare the PostgreSQL database:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">Add the tigase_user:</p><pre class="programlisting">createuser -U admin_db_user -W -D -R -S -P tigase_user</pre><p class="simpara">You will be asked for credentials for admin_db_user and password for new database user.</p></li><li class="listitem"><p class="simpara">Create the database for the Tigase server with tigase_user as owner of database:</p><pre class="programlisting">createdb -U admin_db_user -W -O tigase_user tigasedb</pre></li><li class="listitem"><p class="simpara">Load database schema to initialize the Tigase server from the file that corresponds to the Tigase version you want to use.</p><pre class="programlisting">psql -q -U tigase_user -W tigasedb -f database/postgresql-schema-7-1.sql
psql -q -U tigase_user -W tigasedb -f database/postgresql-pubsub-schema-3.2.0.sql</pre><p class="simpara">If you want to use the socks5 proxy component, then add the following line:</p><pre class="programlisting">psql -q -U tigase_user -W tigasedb -f database/postgresql-socks5-schema.sql</pre><p class="simpara">The above commands should be executed from the main Tigase directory. The initialization schema file should be also available locally in database/ directory of your Tigase installation.</p></li></ol></div></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="mongoDBSupport"></a>Preparing Tigase for MongoDB</h3></div></div></div><p>Tigase now supports MongoDB for auth, settings, and storage repositories. If you wish to use MongoDB for Tigase, please use this guide to help you.</p><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_dependencies"></a>Dependencies</h4></div></div></div><p>To run Tigase MongoDB support library requires drivers for MongoDB for Java which can be downloaded from <a class="link" href="https://github.com/mongodb/mongo-java-driver/releases" target="_top">here</a>. This driver needs to be placed in /jars directory located in Tigase XMPP Server installation directory.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_configuration_2"></a>Configuration</h4></div></div></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_configuration_of_user_repository_for_tigase_xmpp_server"></a>Configuration of user repository for Tigase XMPP Server</h5></div></div></div><p>To configure Tigase XMPP Server to use MongoDB you need to set --user-db-uri= in etc/init.properties file to proper MongoDB URI pointing to which MongoDB database should be used (it will be created by MongoDB if it does not exist).
--user-db property should not be set to let Tigase XMPP Server autodetect proper implementation of UserRepository. Tigase XMPP Server will create proper collections in MongoDB if they do not exist so no schema files are necessary.</p><p>Example configuration of XMPP Server pointing to MongoDB database tigase_test in a local instance:</p><pre class="programlisting">--user-db-uri=mongodb://localhost/tigase_test</pre><p>If Tigase Server is not able to detect a proper storage layer implementation, it can be forced to use one provided by Tigase using the following lines in etc/init.properties file:</p><pre class="screen">--user-db=tigase.mongodb.MongoRepository
--auth-db=tigase.mongodb.MongoRepository</pre><p>Every component should be able to use proper implementation to support MongoDB using this URI. Also MongoDB URI can be passed as any URI in configuration of any component.</p></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_configuration_for_muc"></a>Configuration for MUC</h5></div></div></div><p>By default, MUC component will use MongoDB to store data if Tigase is configured to use it as a default store. However, if you would like to use a different MongoDB database to store MUC message archive, you can do this by adding the following line to etc/init.properties file:</p><pre class="screen">muc/history-db-uri=mongodb://localhost/tigase_test</pre><p>If MUC components fails to detect and use a proper storage layer for MongoDB, you can force it to use one provided by Tigase by using the following line in the init.properties file:</p><pre class="screen">muc/history-db=tigase.mongodb.muc.MongoHistoryProvider</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_configuration_for_pubsub"></a>Configuration for PubSub</h5></div></div></div><p>By default, PubSub component will use MongoDB to store data if Tigase is configured to use it as a default store. However, if you would like to use a different MongoDB database to store PubSub component data, you can do this by adding the following line to etc/init.properties file:</p><pre class="screen">pubsub/pubsub-repo-url=mongodb://localhost/tigase_test</pre><p>If the PubSub components fails to detect and use a proper storage layer for MongoDB, you can force it to use one provided by Tigase by using the following line in the init.properties file:</p><pre class="screen">pubsub/pubsub-repo-class=tigase.mongodb.pubsub.PubSubDAOMongo</pre></div><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_configuration_for_message_archiving"></a>Configuration for Message Archiving</h5></div></div></div><p>By default, the Message Archiving component will use MongoDB to store data if Tigase is configured to use it as a default store. However, if you would like to use a different MongoDB database to store message archives, you can do this by adding the following line to etc/init.properties file:</p><pre class="screen">message-archive/archive-repo-uri=mongodb://localhost/tigase_test</pre><p>If Message Archiving component fails to detect and use a proper storage layer for MongoDB, you can force it to use one provided by Tigase by using the following line in the init.properties file:</p><pre class="screen">message-archive/archive-repo-class=tigase.mongodb.archive.MongoMessageArchiveRepository</pre></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_schema_description"></a>Schema Description</h4></div></div></div><p>This description contains only basic description of schema and only basic part of it. More collections may be created if additional components of Tigase XMPP Server are loaded and configured to use MongoDB.</p><div class="section"><div class="titlepage"><div><div><h5 class="title"><a name="_tigase_xmpp_server_schema"></a>Tigase XMPP Server Schema</h5></div></div></div><p>Basic schema for UserRespository and AuthRepository consists of two collections:
. tig_users - contains list of users
. tig_nodes - contains data related to users in tree-like way</p><p>tig_users collection contains the following fields:</p><div class="table"><a name="d0e5427"></a><p class="title"><b>Table&nbsp;7.1.&nbsp;tig_users</b></p><div class="table-contents"><table summary="tig_users" border="1" width="50%"><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>_id</p></td><td align="left" valign="top"><p>id of user which is SHA256 hash of users jid (raw byte array)</p></td></tr><tr><td align="left" valign="top"><p>user_id</p></td><td align="left" valign="top"><p>contains full user jid</p></td></tr><tr><td align="left" valign="top"><p>domain</p></td><td align="left" valign="top"><p>domain to which user belongs for easier lookup of users by domain</p></td></tr><tr><td align="left" valign="top"><p>password</p></td><td align="left" valign="top"><p>password of user (or hash of password)</p></td></tr></tbody></table></div></div><br class="table-break"><p>tig_nodes collection contains the following fields</p><div class="table"><a name="d0e5473"></a><p class="title"><b>Table&nbsp;7.2.&nbsp;tig_nodes</b></p><div class="table-contents"><table summary="tig_nodes" border="1" width="50%"><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>_id</p></td><td align="left" valign="top"><p>id of row autogenerated by MongoDB</p></td></tr><tr><td align="left" valign="top"><p>uid</p></td><td align="left" valign="top"><p>id of user which is SHA256 hash of users jid (raw byte array)</p></td></tr><tr><td align="left" valign="top"><p>node</p></td><td align="left" valign="top"><p>full path of node in tree-like structure separated by / (may not exist)</p></td></tr><tr><td align="left" valign="top"><p>key</p></td><td align="left" valign="top"><p>key for which value for node is set</p></td></tr><tr><td align="left" valign="top"><p>value</p></td><td align="left" valign="top"><p>value which is set for node key</p></td></tr></tbody></table></div></div><br class="table-break"><p>Tigase XMPP Server also uses additional collections for storage of Offline Messages</p><div class="table"><a name="d0e5526"></a><p class="title"><b>Table&nbsp;7.3.&nbsp;msg_history collection</b></p><div class="table-contents"><table summary="msg_history collection" border="1" width="50%"><colgroup><col class="col_1"><col class="col_2"></colgroup><thead><tr><th align="left" valign="top">Name</th><th align="left" valign="top">Description</th></tr></thead><tbody><tr><td align="left" valign="top"><p>from</p></td><td align="left" valign="top"><p>full user jid of message sender</p></td></tr><tr><td align="left" valign="top"><p>from_hash</p></td><td align="left" valign="top"><p>SHA256 hash of message sender jid as raw byte array</p></td></tr><tr><td align="left" valign="top"><p>to</p></td><td align="left" valign="top"><p>full users jid of message recipient</p></td></tr><tr><td align="left" valign="top"><p>to_hash</p></td><td align="left" valign="top"><p>SHA256 hash of message recipient full jid as raw byte array</p></td></tr><tr><td align="left" valign="top"><p>ts</p></td><td align="left" valign="top"><p>timestamp of message as date</p></td></tr><tr><td align="left" valign="top"><p>message</p></td><td align="left" valign="top"><p>serialized XML stanza containing message</p></td></tr><tr><td align="left" valign="top"><p>expire-at</p></td><td align="left" valign="top"><p>timestamp of expiration of message (if message contains AMP expire-at set)</p></td></tr></tbody></table></div></div><br class="table-break"></div></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="databasemgnt.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="databasemgnt.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="hashedPasswords.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;7.&nbsp;Database Management&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Hashed User Passwords in Database</td></tr></table></div></body></html>