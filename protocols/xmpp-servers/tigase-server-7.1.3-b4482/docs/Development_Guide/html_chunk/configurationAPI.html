<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Configuration API</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Development Guide"><link rel="up" href="componentdevelpoment.html" title="Chapter&nbsp;4.&nbsp;Component Development"><link rel="prev" href="cil8.html" title="Component Implementation - Lesson 8 - Startup Time"><link rel="next" href="packetfiltering.html" title="Packet Filtering in Components"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Configuration API</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="cil8.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;4.&nbsp;Component Development</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="packetfiltering.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="configurationAPI"></a>Configuration API</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_introduction"></a>Introduction</h3></div></div></div><p>The component configuration API is quite simple, it consists of two methods:</p><pre class="programlisting">Map&lt;String, Object&gt; getDefaults(Map&lt;String, Object&gt; params);
void setProperties(Map&lt;String, Object&gt; properties);</pre><p>The first method retrieves configuration defaults from the component while the second sets the new configuration for the component. Although it looks simple, and it is, we should go over some details in order to use them more effectively.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_component_startup_sequence"></a>Component Startup Sequence</h3></div></div></div><p>Before we go into all the details it might be helpful to know the full component initialization sequence, how the component is brought to life and when the configuration is set. The component loading and starting sequence looks like this:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Component class is loaded and a new class instance is created using public constructor with no parameters.</li><li class="listitem">Component setName(<code class="literal">compName</code>); method is called to set a name for the component. This method is (should) be called only once in the components operation.</li><li class="listitem">Component <code class="literal">start();</code> method is called which starts all the component internal threads. This method, together with <code class="literal">stop();</code> can be called many times to put the component processing on hold or restart processing. Developers should normally not be concerned about these, unless he decided to overwrite these methods.</li><li class="listitem">Component <code class="literal">getDefaults();</code> method is called to retrieve initial settings for the component. This method is normally called only once during operation.</li><li class="listitem">User provided configuration is mixed with the component defaults. Settings which the user has provided overwrite existing defaults, leaving the rest unchanged.</li><li class="listitem">Component <code class="literal">setProperties();</code> is called to set new configuration for the component. This method can be called many times at any point during the component life time.</li><li class="listitem">Component <code class="literal">initializationCompleted();</code> method is called to notify the component that the global server initialization has been finished. This method is called only once during the server startup time, after all components have been initialized and configured. This method is mainly used by network connection managers which wait with activating socket listeners until the server is fully functional.</li></ol></div><p>The important thing about all the configuration stuff is that the component does not read/ask/request configuration. <span class="strong"><strong>The configuration is pushed to the component by the configuration manager.</strong></span> The <code class="literal">setProperties()</code> method can be called at any time and any number of times while the server is running. This design allows for the server reconfiguration during runtime. Developers should be aware of this and properly code the method to allow for the component reconfiguration at runtime.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuration_api"></a>Configuration API</h3></div></div></div><p>Both API methods operate on Map&lt;String, Object&gt;, hence, essentially the component configuration is just a list of <code class="literal">(key, value)</code> pairs. The Object can any of following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">String</li><li class="listitem">Integer</li><li class="listitem">Long</li><li class="listitem">Double</li><li class="listitem">Boolean</li><li class="listitem">Array of any of above</li></ul></div><p>It is guaranteed that if the component returns a default configuration entry in any of above types, the <code class="literal">setProperties()</code> method sets the configuration entry in the same exact type. This is quite convenient as you can limit type conversions (numbers parsing for example) in your code.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_getdefaults"></a>getDefaults()</h3></div></div></div><pre class="programlisting">Map&lt;String, Object&gt; getDefaults(Map&lt;String, Object&gt; params);</pre><p><span class="emphasis"><em>This method is normally called only once, just after the component instance has been created. It is used to get some initial settings from the component and create a default/initial configuration which can be modified by the user. It is recommended that the component returns all possible settings with it&#8217;s default values so they can be presented to the end-user for configuration or diagnostic purposes.  No component initialisation can take place here and the developer can not assume that this method is called only once. Every time this method is called it should return only defaults not the settings set with <code class="literal">setProperties()</code>.  The <code class="literal">Map&lt;String, Object&gt;</code> params provided as a parameter to this method can contain some <span class="emphasis"><em>hints</em></span> or <span class="emphasis"><em>pre-initial</em></span> parameters which can affect generating default configuration. This is because configuration for some components may be complex and can have many different presets or optimisations depending on the use case. These presets can be used to generate proper default configuration.  If the component implementation extends AbstractMessageReceiver then the implementation of the method should always look like this:</em></span></p><pre class="programlisting">@Override
public Map&lt;String, Object&gt; getDefaults(Map&lt;String, Object&gt; params) {
  Map defs = super.getDefaults(params);
  defs.put(CONF_ENTRY_KEY, conf_entry_val);
  return defs;
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_setproperties"></a>setProperties()</h3></div></div></div><pre class="programlisting">void setProperties(Map&lt;String, Object&gt; properties);</pre><p><span class="emphasis"><em>This method is called to set configuration for the component. It can be called at any time and many times during the server run-time. The configuration will always contain all entries returned by <code class="literal">getDefaults</code> method but some of them might be overwritten by user provided settings.  If the component implementation extends <code class="literal">AbstractMessageReceiver</code> then the implementation of the method should always look like this:</em></span></p><pre class="programlisting">@Override
public void setProperties(Map properties) {
  super.setProperties(properties);
  int conf_entry_val = (Integer) properties.get(CONF_ENTRY_KEY);
}</pre></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_useful_presets"></a>Useful Presets</h3></div></div></div><p>Normally configuration presets depend on the component implementation and are different for each component. There are a few presets however which are often used commonly by different components:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">test</code> If set it means that the server runs in a test mode, which may mean different things for different components. The component may use this parameter to turn testing mode on.</li><li class="listitem"><code class="literal">admins</code> If set it provides a list of administrator IDs. These user may have special access permissions for the component. They usually can execute administrator ad-hoc commands.</li><li class="listitem"><code class="literal">user-db-uri</code> If set it contains the main database connection string. The component may keep its own data.</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_global_configuration_settings"></a>Global Configuration Settings</h3></div></div></div><p>There are some global settings which are provided to all components and can be used by all of them. Usually they point so some shared resources which can be used by all components.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>SHARED_USER_REPO_PROP_KEY</strong></span> is a configuration key for the user repository instance. This instance can be shared among components and used to store component data in database as well as access to user data.
To access the use repository instance you can use the following code:</li></ul></div><pre class="screen">UserRepository user_repo;
user_repo = (UserRepository) properties.get(RepositoryFactory.SHARED_USER_REPO_PROP_KEY);</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>SHARED_USER_REPO_POOL_PROP_KEY</strong></span> is a configuration key for the user repository pool which in most cases is just an SQL database. To improve the access to the database a connection pool is created which is realized by creating many UserRepository instances connecting to the same database.
To access the use repository instance you can use the following code:</li></ul></div><pre class="programlisting">UserRepository user_repo;
user_repo = (UserRepository) properties.get(RepositoryFactory.SHARED_USER_REPO_POOL_PROP_KEY);</pre><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>SHARED_AUTH_REPO_PROP_KEY</strong></span> is a configuration key for the authentication repository. Components normally do not need access to this repository unless they deal with user authentication and authentication data is kept separately from the rest of the user data.
To access the use repository instance you can use the following code:</li></ul></div><pre class="programlisting">AuthRepository auth_repo;
auth_repo = (AuthRepository) properties.get(RepositoryFactory.SHARED_AUTH_REPO_PROP_KEY);</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="cil8.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="componentdevelpoment.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="packetfiltering.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Component Implementation - Lesson 8 - Startup Time&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Packet Filtering in Components</td></tr></table></div></body></html>