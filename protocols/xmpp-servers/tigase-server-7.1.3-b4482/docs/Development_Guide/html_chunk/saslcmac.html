<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>SASL Custom Mechanisms and Configuration</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Development Guide"><link rel="up" href="pluginDev.html" title="Chapter&nbsp;5.&nbsp;Plugin Development"><link rel="prev" href="packetProcess.html" title="How Packets are Processed by the SM and Plugins"><link rel="next" href="usingmaven.html" title="Chapter&nbsp;6.&nbsp;Using Maven"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">SASL Custom Mechanisms and Configuration</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="packetProcess.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;5.&nbsp;Plugin Development</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="usingmaven.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="saslcmac"></a>SASL Custom Mechanisms and Configuration</h2></div></div></div><p><span class="strong"><strong>This API is available from Tigase XMPP Server version 5.2.0 or later on our current master branch.</strong></span></p><p><span class="emphasis"><em>Note that API is under active development. This description may be updated at any time.</em></span></p><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_basic_sasl_configuration"></a>Basic SASL Configuration</h3></div></div></div><p>SASL implementation in Tigase XMPP Server is compatible with Java API, the same exact interfaces are used.</p><p>The SASL implementation consists of following parts:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">mechanism</li><li class="listitem">CallbackHandler</li></ol></div><p>Properties list for SASL plugin <span class="emphasis"><em>(sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl):</em></span></p><div class="informaltable"><table border="1" width="90%"><colgroup><col class="col_1"><col class="col_2"></colgroup><tbody><tr><td align="left" valign="top"><p><span class="strong"><strong>Property</strong></span></p></td><td align="left" valign="top"><p><span class="strong"><strong>Description</strong></span></p></td></tr><tr><td align="left" valign="top"><p>factory</p></td><td align="left" valign="top"><p>A factory class for SASL mechanisms. Detailed description at <a class="link" href="saslcmac.html#mechconf" title="Mechanisms Configuration">Mechanisms configuration</a></p></td></tr><tr><td align="left" valign="top"><p>callbackhandler</p></td><td align="left" valign="top"><p>A default callback handler class. Detailed description at <a class="link" href="saslcmac.html#cbconf" title="CallbackHandler Configuration">CallbackHandler configuration</a></p></td></tr><tr><td align="left" valign="top"><p>callbackhandler-${MECHANISM}</p></td><td align="left" valign="top"><p>A callback handler class for a particular mechanism. Detailed description at <a class="link" href="saslcmac.html#cbconf" title="CallbackHandler Configuration">CallbackHandler configuration</a></p></td></tr><tr><td align="left" valign="top"><p>mechanism-selector</p></td><td align="left" valign="top"><p>A class for filtering SASL mechanisms available in a stream. Detailed description at <a class="link" href="saslcmac.html#selmech" title="Selecting Mechanisms Available in the Stream">Selecting mechanisms</a></p></td></tr></tbody></table></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="mechconf"></a>Mechanisms Configuration</h4></div></div></div><p>To add a new mechanism, a new factory for the mechanism has to be registered. It can be done with a new line in the <code class="literal">init.properties</code> file like this one:</p><p><code class="literal">sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/factory=com.example.OwnFactory</code></p><p>The class must implement the <code class="literal">SaslServerFactory</code> interface. All mechanisms returned by <code class="literal">getMechanismNames()</code> method will be registered automatically.</p><p>The default factory that is available and registered by default is <code class="literal">tigase.auth.TigaseSaslServerFactory</code> which provides <code class="literal">PLAIN</code> and <code class="literal">ANONYMOUS</code> mechanisms.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="cbconf"></a>CallbackHandler Configuration</h4></div></div></div><p>The <code class="literal">CallbackHandler</code> is a helper class used for loading/retrieving authentication data from data repository and providing them to a mechanism.</p><p>To register a new callback handler a new line in the <code class="literal">init.properties</code> file like this one has to be added:</p><p><code class="literal">sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/callbackhandler=com.example.DefaultCallbackHandler</code></p><p>It is also possible to register different callback handlers for different mechanisms:</p><p><code class="literal">sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/callbackhandler-PLAIN=com.example.PlainCallbackHandler</code></p><p><code class="literal">sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/callbackhandler-OAUTH=com.example.OAuthCallbackHandler</code></p><p>During the authentication process, Tigase server always checks for a handler specific to selected mechanisms, and if there is no specific handler the default one is used.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="selmech"></a>Selecting Mechanisms Available in the Stream</h4></div></div></div><p>The <code class="literal">tigase.auth.MechanismSelector</code> interface is used for selecting mechanisms available in a stream. Method <code class="literal">filterMechanisms()</code> should return a collection with mechanisms available based on:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">all registered SASL factories</li><li class="listitem">XMPP session data (from <code class="literal">XMPPResourceConnection</code> class)</li></ol></div><p>The default selector returns mechanisms from Tigase&#8217;s default factory <code class="literal">(TigaseSaslServerFactory)</code> only.</p><p>It is possible to use a custom selector by specifying it&#8217;s class int the <code class="literal">init.properties</code> file:</p><p><code class="literal">sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/mechanism-selector=com.example.OwnSelector</code></p></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_logging_authentication"></a>Logging/Authentication</h3></div></div></div><p>After the XMPP stream is opened by a client, the server checks which SASL mechanisms are available for the XMPP session. Depending on whether the stream is encrypted or not, depending on the domain, the server can present different available authentication mechanisms. MechanismSelector is responsible for choosing mechanisms. List of allowed mechanisms is stored in the XMPP session object.</p><p>When the client/user begins the authentication procedure it uses one particular mechanism. It must use one of the mechanisms provided by the server as available for this session. The server checks whether mechanisms used by the client is on the list of allowed mechanisms. It the check is successful, the server creates <code class="literal">SaslServer</code> class instance and proceeds with exchanging authentication information. Authentication data is different depending on the mechanism used.</p><p>When the SASL authentication is completed without any error, Tigase server should have authorized user name or authorized BareJID. In the first case, the server automatically builds user&#8217;s JID based on the domain used in the stream opening element in <code class="literal">to</code> attribute.</p><p>If, after a successful authentication, method call: <code class="literal">getNegotiatedProperty("IS_ANONYMOUS")</code> returns <code class="literal">Boolean.TRUE</code> then the user session is marked as anonymous. For valid and registered users this can be used for cases when we do not want to load any user data such as roster, vcard, privacy lists and so on. This is a performance and resource usage implication and can be useful for use cases such as support chat. The authorization is performed based on the client database but we do not need to load any XMPP specific data for the user&#8217;s session.</p><p>More details about implementation can be found in the <a class="link" href="saslcmac.html#cmd" title="Custom Mechanisms Development">custom mechanisms development</a> section.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_built_in_mechanisms"></a>Built-in Mechanisms</h3></div></div></div><p><span class="strong"><strong>PLAIN</strong></span></p><p><span class="emphasis"><em>TODO!</em></span></p><p><span class="strong"><strong>ANONYMOUS</strong></span></p><p><span class="emphasis"><em>TODO!</em></span></p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="cmd"></a>Custom Mechanisms Development</h3></div></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__emphasis_role_strong_mechanism_emphasis"></a><span class="strong"><strong>Mechanism</strong></span></h4></div></div></div><p><code class="literal">getAuthorizationID()</code> method from <code class="literal">SaslServer</code> class <span class="strong"><strong>should</strong></span> return bare JID authorized user. In case that the method returns only user name such as <span class="strong"><strong>romeo</strong></span> for example, the server automatically appends domain name to generate a valid BareJID: <span class="emphasis"><em>romeo@example.com</em></span>. In case the method returns a full, valid BareJID, the server does not change anything.</p><p><code class="literal">handleLogin()</code> method from <code class="literal">SessionManagerHandler</code> will be called with user&#8217;s Bare JID provided by <code class="literal">getAuthorizationID()</code> (or created later using stream domain name).</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="__emphasis_role_strong_callbackhandler_emphasis"></a><span class="strong"><strong>CallbackHandler</strong></span></h4></div></div></div><p>For each session authorization, the server creates a new and separate empty handler. Factory which creates handler instance allows to inject different objects to the handler, depending on interfaces implemented by the handler class:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><code class="literal">AuthRepositoryAware</code> - injects <code class="literal">AuthRepository;</code></li><li class="listitem"><code class="literal">DomainAware</code> - injects domain name within which the user attempts to authenticate</li><li class="listitem"><code class="literal">NonAuthUserRepositoryAware</code> - injects <code class="literal">NonAuthUserRepository</code>, although I have no idea what for&#8230;&#8203;</li></ul></div></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_general_remarks"></a>General Remarks</h4></div></div></div><p><code class="literal">JabberIqAuth</code> used for non-SASL authentication mechanisms uses the same callback as the SASL mechanisms.</p><p>Methods <code class="literal">auth</code> in <code class="literal">Repository</code> interfaces will be deprecated. These interfaces will be treated as user details providers only. There will be new methods available which will allow for additional login operations on the database such as last successful login recording.</p></div><div class="section"><div class="titlepage"><div><div><h4 class="title"><a name="_known_problems"></a>Known Problems</h4></div></div></div><p>Because <code class="literal">JabberIqAuth</code> is initialized separately, we strongly recommend to use more general prefix in <span class="strong"><strong><code class="literal">init.properties</code></strong></span>:</p><pre class="programlisting">sess-man/plugins-conf/${KEY}=${VALUE}</pre><p>instead of</p><pre class="programlisting">sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/${KEY}=${VALUE}</pre><p>If <code class="literal">JabberIqAuth</code> is disabled, then this is not necessary.</p></div></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="packetProcess.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="pluginDev.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="usingmaven.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">How Packets are Processed by the SM and Plugins&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;6.&nbsp;Using Maven</td></tr></table></div></body></html>