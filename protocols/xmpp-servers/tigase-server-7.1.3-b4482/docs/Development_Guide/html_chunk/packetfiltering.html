<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Packet Filtering in Components</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Development Guide"><link rel="up" href="componentdevelpoment.html" title="Chapter&nbsp;4.&nbsp;Component Development"><link rel="prev" href="configurationAPI.html" title="Configuration API"><link rel="next" href="eventBus.html" title="EventBus API in Tigase"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Packet Filtering in Components</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="configurationAPI.html">Prev</a>&nbsp;</td><th width="60%" align="center">Chapter&nbsp;4.&nbsp;Component Development</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="eventBus.html">Next</a></td></tr></table><hr></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="packetfiltering"></a>Packet Filtering in Components</h2></div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_the_packet_filter_api"></a>The Packet Filter API</h3></div></div></div><p>Tigase server offers an API to filter packet traffic inside every component. You can separately filter incoming and outgoing packets.</p><p>By filtering we mean intercepting a packet and possibly making some changes to the packet or just blocking the packet completely. By blocking we mean stopping from any further processing and just dropping the packet.</p><p>The packet filtering is based on the <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/changes/src/main/java/tigase/server/PacketFilterIfc.java" target="_top">PacketFilterIfc</a> interface. Please have a look in the JavaDoc documentation to this interface for all the details. The main filtering method is +Packet filter(Packet packet); + which takes packets as an input, processes it, possibly alerting the packet content (may add or remove some payloads) and returns a <span class="strong"><strong>Packet</strong></span> for further processing. If it returns <span class="strong"><strong>null</strong></span> it means the packet is blocked and no further processing is permitted otherwise it returns a <span class="strong"><strong>Packet</strong></span> object which is either the same object it received as a parameter or a modified copy of the original object.</p><p>Please note, although <span class="strong"><strong>Packet</strong></span> object is not unmodifiable instance it is recommended to not make any changes on the existing object. The same <span class="strong"><strong>Packet</strong></span> might be processed at the same time by other components or threads, therefore modification of the <span class="strong"><strong>Packet</strong></span> may lead to unpredictable results.</p><p>Please refer to an example code in <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/changes/src/main/java/tigase/server/PacketFilterIfc.java" target="_top">PacketCounter</a> which is a very simple filter counting different types of packets. This filter is by default loaded to all components which might be very helpful for assessing traffic shapes on newly deployed installation. You can get counters for all types of packets, where they are generated, where they flow, what component they put the most load on.</p><p>This is because packet filter can also generate and present its own statistics which are accessible via normal statistics monitoring mechanisms. To take advantage of the statistics functionality the packet filter has to implement <code class="literal">void getStatistics(StatisticsList list);</code> method. Normally the method can be empty but you can generate and add to the list own statistics from the filter. Please refer to <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/changes/src/main/java/tigase/server/filters/PacketCounter.java" target="_top">PacketCounter</a> for an example implementation code.</p></div><div class="section"><div class="titlepage"><div><div><h3 class="title"><a name="_configuration"></a>Configuration</h3></div></div></div><p>Packet filters are configurable, that is a list of packet filters can be provided in Tigase server&#8217;s configuration for each component separately and for each traffic direction. This gives you a great flexibility and control over the data flow inside the Tigase server.</p><p>You can for example, load specific packet filters to all connections managers to block specific traffic or specific packet source from sending messages to users on your server. You could also reduce the server overall load by removing certain payload from all packets. The possibilities are endless.</p><p>The default configuration is generated in such a way that each component loads a single packet filter - PacketCounter for each traffic direction:</p><pre class="programlisting">message-router/incoming-filters=tigase.server.filters.PacketCounter
message-router/outgoing-filters=tigase.server.filters.PacketCounter
sess-man/incoming-filters=tigase.server.filters.PacketCounter
sess-man/outgoing-filters=tigase.server.filters.PacketCounter
c2s/incoming-filters=tigase.server.filters.PacketCounter
c2s/outgoing-filters=tigase.server.filters.PacketCounter
s2s/incoming-filters=tigase.server.filters.PacketCounter
s2s/outgoing-filters=tigase.server.filters.PacketCounter
bosh/incoming-filters=tigase.server.filters.PacketCounter
bosh/outgoing-filters=tigase.server.filters.PacketCounter
muc/incoming-filters=tigase.server.filters.PacketCounter
muc/outgoing-filters=tigase.server.filters.PacketCounter</pre><p>Now, let&#8217;s say you have a packet filter implemented in class: <span class="strong"><strong>com.company.SpamBlocker</strong></span>. You want to disable PacketCounter on most of the components leaving it only in the message router component and you want to install SpamBlocker in all connection managers.</p><p><span class="emphasis"><em>Please note, in case of the connection managers <span class="emphasis"><em>incoming</em></span> and <span class="emphasis"><em>outgoing</em></span> traffic is probably somehow opposite from what you would normally expect.</em></span></p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>incoming</strong></span> is traffic which is submitted to a component by message router and has to be further processed. For connection managers this further processing means sending it out to the network.</li><li class="listitem"><span class="strong"><strong>outgoing</strong></span> is traffic which is <span class="emphasis"><em>generated</em></span> by the component and goes out of the component. Such a packet is submitted to message router which then decides where to send it for further processing. For connection managers <span class="strong"><strong>outgoing</strong></span> traffic is all the packets just received from the network.</li></ul></div><p>According to that we have to apply the SpamBlocker filter to all <span class="emphasis"><em>outgoing</em></span> traffic in all connection managers. You may also decide that it might be actually useful to compare traffic shape between Bosh connections and standard XMPP c2s connections. So let&#8217;s leave packet counters for this components too.</p><p>Here is our new configuration applying SpamBlocker to connection managers and PacketCounter to a few other components:</p><pre class="programlisting">message-router/incoming-filters=tigase.server.filters.PacketCounter
message-router/outgoing-filters=tigase.server.filters.PacketCounter
sess-man/incoming-filters=
sess-man/outgoing-filters=
c2s/incoming-filters=tigase.server.filters.PacketCounter
c2s/outgoing-filters=tigase.server.filters.PacketCounter,com.company.SpamBlocker
s2s/incoming-filters=
s2s/outgoing-filters=com.company.SpamBlocker
bosh/incoming-filters=tigase.server.filters.PacketCounter
bosh/outgoing-filters=tigase.server.filters.PacketCounter,com.company.SpamBlocker
muc/incoming-filters=
muc/outgoing-filters=</pre><p>The simplest way to apply the new configuration is via the init.properties file which is in details described in the <span class="emphasis"><em>Admin Guide</em></span>.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="configurationAPI.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="u" href="componentdevelpoment.html">Up</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="eventBus.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Configuration API&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;EventBus API in Tigase</td></tr></table></div></body></html>