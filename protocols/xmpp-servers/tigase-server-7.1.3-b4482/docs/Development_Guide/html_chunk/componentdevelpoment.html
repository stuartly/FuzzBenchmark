<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;4.&nbsp;Component Development</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Development Guide"><link rel="up" href="index.html" title="Tigase Development Guide"><link rel="prev" href="scv4ol.html" title="Tigase Packages Dependency Change - Server Compilation Version 4.x or Later"><link rel="next" href="cil2.html" title="Component Implementation - Lesson 2 - Configuration"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;4.&nbsp;Component Development</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="scv4ol.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="cil2.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="componentdevelpoment"></a>Chapter&nbsp;4.&nbsp;Component Development</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="componentdevelpoment.html#cil1">Component Implementation - Lesson 1 - Basics</a></span></dt><dt><span class="section"><a href="cil2.html">Component Implementation - Lesson 2 - Configuration</a></span></dt><dt><span class="section"><a href="cil3.html">Component Implementation - Lesson 3 - Multi-Threading</a></span></dt><dt><span class="section"><a href="cil4.html">Component Implementation - Lesson 4 - Service Discovery</a></span></dt><dt><span class="section"><a href="cil5.html">Component Implementation - Lesson 5 - Statistics</a></span></dt><dt><span class="section"><a href="cil6.html">Component Implementation - Lesson 6 - Scripting Support</a></span></dt><dt><span class="section"><a href="cil7.html">Component Implementation - Lesson 7 - Data Repository</a></span></dt><dd><dl><dt><span class="section"><a href="cil7.html#_configrepository">ConfigRepository</a></span></dt><dt><span class="section"><a href="cil7.html#_repositoryfactory">RepositoryFactory</a></span></dt></dl></dd><dt><span class="section"><a href="cil8.html">Component Implementation - Lesson 8 - Startup Time</a></span></dt><dt><span class="section"><a href="configurationAPI.html">Configuration API</a></span></dt><dd><dl><dt><span class="section"><a href="configurationAPI.html#_introduction">Introduction</a></span></dt><dt><span class="section"><a href="configurationAPI.html#_component_startup_sequence">Component Startup Sequence</a></span></dt><dt><span class="section"><a href="configurationAPI.html#_configuration_api">Configuration API</a></span></dt><dt><span class="section"><a href="configurationAPI.html#_getdefaults">getDefaults()</a></span></dt><dt><span class="section"><a href="configurationAPI.html#_setproperties">setProperties()</a></span></dt><dt><span class="section"><a href="configurationAPI.html#_useful_presets">Useful Presets</a></span></dt><dt><span class="section"><a href="configurationAPI.html#_global_configuration_settings">Global Configuration Settings</a></span></dt></dl></dd><dt><span class="section"><a href="packetfiltering.html">Packet Filtering in Components</a></span></dt><dd><dl><dt><span class="section"><a href="packetfiltering.html#_the_packet_filter_api">The Packet Filter API</a></span></dt><dt><span class="section"><a href="packetfiltering.html#_configuration">Configuration</a></span></dt></dl></dd><dt><span class="section"><a href="eventBus.html">EventBus API in Tigase</a></span></dt><dd><dl><dt><span class="section"><a href="eventBus.html#_eventbus_api">EventBus API</a></span></dt><dt><span class="section"><a href="eventBus.html#_distributed_eventbus">Distributed EventBus</a></span></dt><dt><span class="section"><a href="eventBus.html#_local_eventbus">Local EventBus</a></span></dt></dl></dd><dt><span class="section"><a href="clusterMapInterface.html">Cluster Map Interface</a></span></dt><dd><dl><dt><span class="section"><a href="clusterMapInterface.html#_requirements_2">Requirements</a></span></dt><dt><span class="section"><a href="clusterMapInterface.html#_map_creation">Map creation</a></span></dt><dt><span class="section"><a href="clusterMapInterface.html#_map_changes">Map Changes</a></span></dt><dt><span class="section"><a href="clusterMapInterface.html#_map_destruction">Map Destruction</a></span></dt></dl></dd></dl></div><p>A component in the Tigase is an entity with its own JID address. It can receive packets, process them, and can also generate packets.</p><p>An example of the best known components is MUC or PubSub. In Tigase however, almost everything is actually a component: Session Manager, s2s connections manager, Message Router, etc&#8230;&#8203; Components are loaded based on the server configuration, new components can be loaded and activated at run-time. You can easily replace a component implementation and the only change to make is a class name in the configuration entry.</p><p>Creating components for Tigase server is an essential part of the server development hence there is a lot of useful API and ready to use code available. This guide should help you to get familiar with the API and how to quickly and efficiently create your own component implementations.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><a class="link" href="componentdevelpoment.html#cil1" title="Component Implementation - Lesson 1 - Basics">Component implementation - Lesson 1 - Basics</a></li><li class="listitem"><a class="link" href="cil2.html" title="Component Implementation - Lesson 2 - Configuration">Component implementation - Lesson 2 - Configuration</a></li><li class="listitem"><a class="link" href="cil3.html" title="Component Implementation - Lesson 3 - Multi-Threading">Component implementation - Lesson 3 - Multi-Threading</a></li><li class="listitem"><a class="link" href="cil4.html" title="Component Implementation - Lesson 4 - Service Discovery">Component implementation - Lesson 4 - Service Discovery</a></li><li class="listitem"><a class="link" href="cil5.html" title="Component Implementation - Lesson 5 - Statistics">Component implementation - Lesson 5 - Statistics</a></li><li class="listitem"><a class="link" href="cil6.html" title="Component Implementation - Lesson 6 - Scripting Support">Component implementation - Lesson 6 - Scripting Support</a></li><li class="listitem"><a class="link" href="cil7.html" title="Component Implementation - Lesson 7 - Data Repository">Component implementation - Lesson 7 - Data Repository</a></li><li class="listitem"><a class="link" href="cil8.html" title="Component Implementation - Lesson 8 - Startup Time">Component implementation - Lesson 8 - Startup Time</a></li><li class="listitem"><a class="link" href="configurationAPI.html" title="Configuration API">Configuration API</a></li><li class="listitem"><a class="link" href="packetfiltering.html" title="Packet Filtering in Components">Packet Filtering in Component</a></li></ol></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="cil1"></a>Component Implementation - Lesson 1 - Basics</h2></div></div></div><p>Creating a Tigase component is actually very simple and with broad API available you can create a powerful component with just a few lines of code. You can find detailed API description elsewhere. This series presents hands on lessons with code examples, teaching how to get desired results in the simplest possible code using existing Tigase API.</p><p>Even though all Tigase components are just implementations of the <span class="strong"><strong>ServerComponent</strong></span> interface I will keep such a low level information to necessary minimum. Creating a new component based on just interfaces, while very possible, is not very effective. This guide intends to teach you how to make use of what is already there, ready to use with a minimal coding effort.</p><p>This is just the first lesson of the series where I cover basics of the component implementation.</p><p>Let&#8217;s get started and create the Tigase component:</p><pre class="programlisting">import java.util.logging.Logger;
import tigase.server.AbstractMessageReceiver;
import tigase.server.Packet;

public class TestComponent extends AbstractMessageReceiver {

  private static final Logger log = Logger.getLogger(TestComponent.class.getName());

  @Override
  public void processPacket(Packet packet) {
    log.finest("My packet: " + packet.toString());
  }

}</pre><p>The only element mandatory when you extend <span class="strong"><strong>AbstractMessageReceiver</strong></span> is the implementation of <span class="strong"><strong>void processPacket(Packet packet)</strong></span> method. This is actually logical as the main task for your component is processing packets. Class name for our new component is <span class="strong"><strong>TestComponent</strong></span> and we have also initialized a separated logger for this class. Doing This is very useful as it allows us to easily find log entries created by our class.</p><p>With these a few lines of code you have a fully functional Tigase component which can be loaded to the Tigase server; it can receive and process packets, shows as an element on service discovery list (for administrators only), responds to administrator ad-hoc commands, supports scripting, generates statistics, can be deployed as an external component, and a few other things.</p><p>Before we go any further with the implementation let&#8217;s configure the component in Tigase server so it is loaded next time the server starts.
Assuming our <span class="strong"><strong>init.properties</strong></span> file looks like this one:</p><pre class="programlisting">config-type = --gen-config-def
--debug = server
--user-db = derby
--admins = admin@devel.tigase.org
--user-db-uri = jdbc:derby:/Tigase/tigasedb
--virt-hosts = devel.tigase.org
--comp-name-1 = muc
--comp-class-1 = tigase.muc.MUCComponent
--comp-name-2 = pubsub
--comp-class-2 = tigase.pubsub.PubSubComponent</pre><p>We can see that it already is configured to load two other components: <span class="strong"><strong>MUC</strong></span> and <span class="strong"><strong>PubSub</strong></span>. Let&#8217;s add a third - our new component to the configuration file by appending two following lines in the properties file:</p><pre class="programlisting">--comp-name-3 = test
--comp-class-3 = TestComponent</pre><p>Now we have to remove the <span class="strong"><strong>etc/tigase.xml</strong></span> file and restart the server.</p><p>There are a few ways to check whether our component has been loaded to the server. Probably the easiest is to connect to the server from an administrator account and look at the service discovery list.</p><p><span class="inlinemediaobject"><img src="./images/service-disco-test-comp-admin-300.png" alt="service-disco-test-comp-admin-300"></span></p><p>If everything goes well you should see an entry on the list similar to the highlighted one on the screenshot. The component description is "<span class="emphasis"><em>Undefined description</em></span>" which is a default description and we can change it later on, the component default JID is: <span class="strong"><strong>test@devel.tigase.org</strong></span>, where <span class="strong"><strong>devel.tigase.org</strong></span> is the server domain and test is the component name.</p><p>Another way to find out if the component has been loaded is by looking at the log files. Getting yourself familiar with Tigase log files will be very useful thing if you plan on developing Tigase components. So let&#8217;s look at the log file <span class="strong"><strong>logs/tigase.log.0</strong></span>, if the component has been loaded you should find following lines in the log:</p><pre class="programlisting">MessageRouter.setProperties() FINER: Loading and registering message receiver: test
MessageRouter.addRouter() INFO: Adding receiver: TestComponent
MessageRouter.addComponent() INFO: Adding component: TestComponent
MessageRouter.addComponent() FINER: Adding: test component to basic-conf registrator.
Configurator.componentAdded() CONFIG:  component: test</pre><p>If your component did not load you should first check configuration files. Maybe you forgot to remove the <span class="strong"><strong>tigase.xml</strong></span> file before restarting the server or alternatively the Tigase could not find your class at startup time. Make sure your class is in <span class="strong"><strong>CLASSPATH</strong></span> or copy a JAR file with your class to Tigase <span class="strong"><strong>libs/</strong></span> directory.</p><p>Assuming everything went well and your component is loaded by the sever and it shows on the service discovery list as on the screenshot above you can double click on it to get a window with a list of ad-hoc commands - administrator scripts. A window on the screenshot shows only two basic commands for adding and removing script which is a good start.</p><p><span class="inlinemediaobject"><img src="./images/commands-list-test-200.png" alt="commands-list-test-200"></span></p><p>Moreover, you can browse the server statistics in the service discovery window to find your new test component on the list. If you click on the component it shows you a window with component statistics, very basic packets counters.</p><p><span class="inlinemediaobject"><img src="./images/service-disco-stats-200.png" alt="service-disco-stats-200"></span></p><p>As we can see with just a few lines of code our new component is quite mighty and can do a lot of things without much effort from the developer side.</p><p>Now, the time has come to the most important question. Can our new component do something useful, that is can it receive and process XMPP packets?</p><p>Let&#8217;s try it out. Using you favorite client send a message to JID: <span class="strong"><strong>test@devel.tigase.org</strong></span> (assuming your server is configured for <span class="strong"><strong>devel.tigase.org</strong></span> domain). You can either use kind of XML console in your client or just send a plain message to the component JID. According to our code in <span class="strong"><strong>processPacket(&#8230;&#8203;)</strong></span> method it should log our message. For this test I have sent a message with subject: "<span class="emphasis"><em>test message</em></span>" and body: "<span class="emphasis"><em>this is a test</em></span>". The log file should contain following entry:</p><pre class="programlisting">TestComponent.processPacket() FINEST: My packet: to=null, from=null,
data=&lt;message from="admin@devel.tigase.org/devel"
  to="test@devel.tigase.org" id="abcaa" xmlns="jabber:client"&gt;
  &lt;subject&gt;test message&lt;/subject&gt;
  &lt;body&gt;this is a test&lt;/body&gt;
&lt;/message&gt;, XMLNS=jabber:client, priority=NORMAL</pre><p>If this is a case we can be sure that everything works as expected and all we now have to do is to fill the <span class="strong"><strong>processPacket(&#8230;&#8203;)</strong></span> method with some useful code.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="scv4ol.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="cil2.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Tigase Packages Dependency Change - Server Compilation Version 4.x or Later&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Component Implementation - Lesson 2 - Configuration</td></tr></table></div></body></html>